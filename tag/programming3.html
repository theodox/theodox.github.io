<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Chimeras & Manticores - Tag programming</title>

            <link href="http://theodox.com/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Chimeras & Manticores Full Atom Feed" />
            <link href="http://theodox.com/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Chimeras & Manticores Full RSS Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="http://theodox.com/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://theodox.com/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://theodox.com/theme/css/code_blocks/zenburn.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Chimeras & Manticores">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://theodox.com/">Chimeras & Manticores</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                        <li><a href="/about">About...</a></li>
                        <li><a href="/pages/pub">Publications</a></li>
                        <li><a href="http://astore.amazon.com/tecsurgui-20">Tech-Art Book Store</a></li>
                        <li><a href="/pages/cookbook">Cookbook</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

        <header class="intro-header" style="background-image: url('http://theodox.com/theme/images/home-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="page-heading">
                        <h1>#programming</h1>
                        <h3>35 items<h3>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-preview">
            <a href="http://theodox.com/2014/dog_ate_my_homework" rel="bookmark" title="Permalink to The Dog Ate My Homework">
                <h2 class="post-title">
                    The Dog Ate My Homework
                </h2>
            </a>
                <p>I had an interesting issue at work the other day. While the details are unit-test specific, I learned a useful general idea that’s worth sharing.  </p>
<p>We run all of our various Maya tools through a single build system which runs unit tests and compiles code for our different targets (currently Maya 2011 and 2015). Ordinarily, since I’m very allergic to using binaries when I don’t have to, this multi-maya setup doesn’t cause us a lot of headaches. I have a little extractor routine which unzips the few binaries we do distribute in the right places, and all the rest of the code is blissfully unaware of which Maya version it’s running (with the exception of the nasty <a href="http://techartsurvival.blogspot.com/2014/09/2015-bug-watch-ls.html">ls bug I mentioned a few weeks ago</a>.)  </p>
<p><a href="http://rs1img.memecdn.com/how-many-times-have-you-heard-amp-quot-my-dog-ate-my-homework-amp-quot_fb_2216011.jpg"><img alt="" src="http://rs1img.memecdn.com/how-many-times-have-you-heard-amp-quot-my-dog-ate-my-homework-amp-quot_fb_2216011.jpg" /></a></p>
<p>Last week, however, we added a new tool and accompanying test suite to the toolkit. It works fine in 2015 (where we do all of our actual development right now), but crashes in 2011. After a bit of head-scratching we eventually realized that this one was absurdly simple: the test uses a saved Maya so that it can work with known, valid data. Of course the file was saved from Maya 2015, so when the Maya 2011 version of the tests tries to run boot up, it falls over because 2011 won’t read a 2015 file.<br />
Or, as the checkin comment has it, “Doh!”  </p>
<h2>Test cancelled!</h2>
<p>The obvious fix is just to skip the test in Maya 2011 - a test that can never pass is hardly generating much useful information, and the likelihood that our small pool of 2011 customers actually need this tool is low anyway. Skipping a test is easy enough if you’re running the tests manually in an IDE – but a lot more complex if you’re got a build server that’s trying to auto-detect the tests. Plus, designing a system that makes it <em>too</em> easy to skip tests is a Bad Thingtm; - you generally want all of your tests running all the time, since “I’ll re-enable that test after I deal with this problem” is right up there with “the check is in the mail” and “it’s not you, it’s me” in the probity department. <br />
So, the goal is to allow us to conditionally disable tests based on a hard constraint - in this case, when they are running on an inappropriate version of Maya - without compromising the tests as a whole . Secondarily it would be nice to do this without any kind of central registry file - we’d really just like the tests to just run, except when they <em>can’t</em>.  </p>
<p><a href="http://i1.wp.com/lotsofhumor.com/wp-content/uploads/2013/04/didnt-study-for-test-test-cancelled.jpg"><img alt="" src="http://i1.wp.com/lotsofhumor.com/wp-content/uploads/2013/04/didnt-study-for-test-test-cancelled.jpg" /></a></p>
<p>Now, typically a test runner will detect tests by looking for classes that derive from <a href="https://docs.python.org/2/library/unittest.html">unittest.TestCase</a>. The easiest way to skip the test, therefore, is simply not to define it at all - if the test runner doesn’t see the class when it imports your test modules, we’ll be fine. <em>Note: this strategy won’t work if you have some kind of hand-rolled test harness that finds tests by string parsing file contents or something like that! However, you probably want to be doing the standard thing anyway… As they say in Python land, <a href="http://legacy.python.org/dev/peps/pep-0020/">“There should be one– and preferably only one –obvious way to do it.”</a></em>  </p>
<p>In C++ or C# you could do this with a “preprocessor directive”, aka a “#define” - a conditional check that runs at compile time to include or exclude certain parts of a file.   </p>
<p>In Python we don’t even need that: you can just inline the check in your file and it will execute when the module is imported. Here’s a simple example which conditionally use Raymond Hettinger’s <a href="https://pypi.python.org/pypi/ordereddict">ordereddict module</a> in Python 2.6 and the equivalent built-in version in Python 2.7:  </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>  
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>  
<span class="k">else</span><span class="p">:</span>  
    <span class="kn">from</span> <span class="nn">ordereddict</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</pre></div>


<p>_(If you are total #IFDEF addict there is also the <a href="http://stackoverflow.com/questions/482014/how-would-you-do-the-equivalent-of-preprocessor-directives-in-python">pypredef module</a>. Not my cup of tea, but the author does make some good points about the utility of his approach). _  </p>
<p>The inline approach works fine in small amounts, but it’s aesthetically unappealing - it forces a bunch of module-level definitions away from the left margin, visually demoting them from important names to generic code blocks. More importantly, it’s easy to mess up: a misplaced indentation can radically change the contents of your file, and even though I’m a big fan of indentations over cur lies, I miss my indents with depressing regularity.  </p>
<p>Fortunately, Python has an elegantly succinct way of annotating code for higher-level purposes without messing up the visual cleanliness and logical flow: <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=240808">decorators</a>. Decorators are handy here for two reasons: first off, they express your intent very clearly by telling future readers something unambiguous about the structure of your code. Secondly, they can execute code (even fairly complex code, though frankly it’s a bad idea for what I’m describing here!) without compromising the layout and readability of your module.<br />
The particularly nice thing about decorators in this case is that the way decorators work in any case is a natural match for the problem we have.   </p>
<h2>The substitute teacher</h2>
<p>A decorator is just a function (or a callable class) which takes another function or class as an argument. When Python finds a decorated function or class, it calls the decorator function and passes the target – that is, the decorated bit of code – as an argument Whatever comes out of the decorator function is then swapped in for the original code. <br />
Here’s a simple example, using functions for simplicity:  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">original_func</span><span class="p">):</span>  
        <span class="k">def</span> <span class="nf">replacement_func</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>  
        <span class="c1"># this function replaces the original  </span>
        <span class="c1"># it only knows what the original does  </span>
        <span class="c1"># because that was passed in when the  </span>
        <span class="c1"># decorator was called....  </span>
        <span class="k">print</span> <span class="s2">&quot;calling original&quot;</span>  
        <span class="n">result</span> <span class="o">=</span> <span class="n">original_func</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  
        <span class="k">print</span> <span class="s2">&quot;original says : &quot;</span><span class="p">,</span> <span class="n">result</span>  
        <span class="k">return</span> <span class="n">result</span>  
    <span class="k">return</span> <span class="n">replacement_func</span>   
    <span class="c1"># return our new replacement function  </span>
    <span class="c1"># but bind it to the name of the original</span>

<span class="nd">@decorated</span>  
<span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>  
   <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

<span class="n">example</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>  
<span class="c1"># calling original  </span>
<span class="c1"># original says : 3  </span>
<span class="k">print</span> <span class="n">example</span><span class="p">:</span>  
<span class="c1"># 3</span>
</pre></div>


<p>The decorator can completely replace the original code if it wants to:  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">override</span><span class="p">(</span><span class="n">original_func</span><span class="p">):</span>  
   <span class="k">def</span> <span class="nf">completely_different</span><span class="p">():</span>  
       <span class="k">return</span> <span class="s2">&quot;and now for something completely different&quot;</span>

<span class="nd">@override</span>  
<span class="k">def</span> <span class="nf">parrot</span><span class="p">():</span>  
    <span class="k">return</span> <span class="s2">&quot;I’d like to make a complaint about a parrot&quot;</span>

<span class="k">print</span> <span class="n">parrot</span><span class="p">()</span>  
<span class="c1"># and now for something completely different</span>
</pre></div>


<p>Or, it could leave it untouched too:  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">untouched</span><span class="p">(</span><span class="n">original_func</span><span class="p">):</span>  
    <span class="k">return</span> <span class="n">original_func</span>

<span class="nd">@untouched</span>  
<span class="k">def</span> <span class="nf">spam</span><span class="p">():</span>  
    <span class="k">return</span> <span class="s2">&quot;spam!&quot;</span>

<span class="k">print</span> <span class="n">spam</span><span class="p">()</span>  
<span class="c1">#spam!</span>
</pre></div>


<p>The essential thing here is that the decorator sort of like one of those elves who swap out children for changelings. Officially nothing has changed - the name you defined in the un-decorated code is right there - but under the hood it may be different.  </p>
<p><a href="http://bartsblackboard.com/files/2009/11/The-Simpsons-05x11-Homer-The-Vigilante.jpg"><img alt="" src="http://bartsblackboard.com/files/2009/11/The-Simpsons-05x11-Homer-The-Vigilante.jpg" /></a></p>
<h2>Mandatory testing</h2>
<p>Once you understand the decorator-as-changeling idea, it becomes pretty easy to see how the decorator can allow code swaps based on some condition. You might, for example, try to patch around a function which returns an empty list in Maya 2014, but <a href="https://www.blogger.com/blogger.g?blogID=3596910715538761404">crashes in Maya 2015</a>(link):  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">safe_2015</span><span class="p">(</span><span class="n">original_func</span><span class="p">):</span>  
        <span class="k">if</span> <span class="s1">&#39;2015&#39;</span> <span class="ow">in</span> <span class="n">cmds</span><span class="o">.</span><span class="n">about</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>  
        <span class="c1"># wrap it for safety in 2015  </span>
        <span class="k">def</span> <span class="nf">safe</span>\<span class="n">_ls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  
            <span class="k">try</span><span class="p">:</span>  
                <span class="k">return</span> <span class="n">original_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>  
                <span class="k">return</span> <span class="p">[]()</span>  
        <span class="k">return</span> <span class="n">safe_ls</span>  
    <span class="k">else</span><span class="p">:</span>  
        <span class="c1"># send it back unchanged in non-2015  </span>
        <span class="k">return</span> <span class="n">original_func</span>

<span class="nd">@safe_2015</span>    
<span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>  
   \<span class="c1">#....</span>
</pre></div>


<blockquote>
<p>Disclaimer: I wouldn’t use this code in practice! It’s a good example of the principle, but not a wise way to patch around the 2015 ls bug.  </p>
</blockquote>
<p>Returning at long last to the problem of suppressing tests: we just need to harness the power of decorators to replace the class definition of our test classes with something else that won’t get run by our test suite. And, luckily, that’s really easy to do since we don’t have to return anything:  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Only2015</span><span class="p">(</span><span class="n">original</span><span class="p">):</span>  
    <span class="k">if</span> <span class="s1">&#39;2015&#39;</span> <span class="ow">in</span> <span class="n">cmds</span><span class="o">.</span><span class="n">about</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>  
            <span class="k">return</span> <span class="n">original</span> <span class="c1"># untouched!  </span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="k">return</span> <span class="nb">object</span> <span class="c1"># the decorated class is now just object</span>
</pre></div>


<p>So if your do something like this in your tests:  </p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>  
<span class="kn">import</span> <span class="nn">maya.standalone</span>  
<span class="k">try</span><span class="p">:</span>  
    <span class="n">maya</span><span class="o">.</span><span class="n">standalone</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>  
<span class="k">except</span><span class="p">:</span>  
    <span class="k">pass</span>


<span class="nd">@Only2015</span>  
<span class="k">class</span> <span class="nc">Test2015Only</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">test_its_2015</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">assert</span> <span class="s1">&#39;2015&#39;</span> <span class="ow">in</span> <span class="n">cmds</span><span class="o">.</span><span class="n">about</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestOtherVersions</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">test_any_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">assert</span> <span class="s1">&#39;20&#39;</span> <span class="ow">in</span> <span class="n">cmds</span><span class="o">.</span><span class="n">about</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>As you’d expect, both of these test will run and pass when run on a Maya 2015 python. However, under any other version of Maya the file really looks like this:  </p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>  
    <span class="kn">import</span> <span class="nn">maya.standalone</span>  
    <span class="k">try</span><span class="p">:</span>  
        <span class="n">maya</span><span class="o">.</span><span class="n">standalone</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>  
    <span class="k">except</span><span class="p">:</span>  
        <span class="k">pass</span>

<span class="c1"># in 2014 &lt;, this TestCase class has been replaced by a dumb object() class  </span>
<span class="k">class</span> <span class="nc">Test2015Only</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TestOtherVersions</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">test</span>\<span class="n">_any</span>\<span class="n">_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">assert</span> <span class="s1">&#39;20&#39;</span> <span class="ow">in</span> <span class="n">cmds</span><span class="o">.</span><span class="n">about</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>Because <code>Test2015Only()</code> is now an <code>object()</code> instead of a <code>TestCase()</code>, the test runner doesn’t even see it and doesn’t try to run it.  </p>
<h2>Makeup work</h2>
<p>This is a lovely example of why Python can be so much fun. The language has the magical ability to extend itself on the fly - in this case, change the meaning of whole blocks of otherwise conventional code - but at the same time it offers simple, conservative mechanisms that keep that process for degenerating into mere anarchy (or, worse, into <em><a href="http://qph.is.quoracdn.net/main-qimg-eb6eb210fd4116ef10fee083428ed482?convert_to_webp=true">JavaScript</a></em>).  </p>
<p>This particular gimmick was a great way to clean up our messy test set. Predictably, about 30 seconds I verified that it worked I was starting to brainstorm all sorts of cool new uses for this tactic.   </p>
<p>A few more minutes of reflection, however, brought me to see that this kind of trick should be reserved for special occasions. The ability to swap the contents of a name based on runtime condition is definitely cool - but it’s hardly a good practice for readability and maintenance down the road. It happens to be a nice fit for this problem because a test is never going to be used by anything other than the test suite. Trying the same thing with, say, a geometry library that gets imported all over the place would be a nightmare to debug.  </p>
<p>Magic is wonderful but, best used <em>sparingly</em>.  </p>
<p><a href="http://pad2.whstatic.com/images/thumb/f/f5/Get-out-of-Class-Step-6.jpg/670px-Get-out-of-Class-Step-6.jpg"><img alt="" src="http://pad2.whstatic.com/images/thumb/f/f5/Get-out-of-Class-Step-6.jpg/670px-Get-out-of-Class-Step-6.jpg" /></a></p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Thu 30 October 2014
            </p>
<p>There are <a href="http://theodox.com/2014/dog_ate_my_homework#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://theodox.com/2014/maya_plugin_commands" rel="bookmark" title="Permalink to Laziness and cleanliness and MEL, Oh My.">
                <h2 class="post-title">
                    Laziness and cleanliness and MEL, Oh My.
                </h2>
            </a>
                <p>The other day I was following a <a href="http://tech-artists.org/forum/showthread.php?5077-FBX-Exporting-from-Maya">thread on Tech-Artists</a> which reminded me of one of those little Maya things that doesn't really matter, but which drives me bonkers: busted front ends for Maya plugins.  </p>
<p>When a developer makes a plugin for Maya, they can create new Mel commands as well as new nodes. The new commands will ultimately use the same basic strategy to parse their incoming arguments: Maya will give them an <a href="http://knowledge.autodesk.com/support/maya/learn-explore/caas/CloudHelp/cloudhelp/2015/ENU/Maya-SDK/py-ref/class-open-maya-1-1-m-arg-list-html.html">MArgList</a> object and they will have to parse out what that means. If the plugin uses an <a href="http://knowledge.autodesk.com/support/maya/getting-started/caas/CloudHelp/cloudhelp/2015/ENU/Maya-SDK/py-ref/class-open-maya-1-1-m-syntax-html.html">MSyntax</a> and an <a href="http://knowledge.autodesk.com/support/maya/getting-started/caas/CloudHelp/cloudhelp/2015/ENU/Maya-SDK/py-ref/class-open-maya-1-1-m-arg-parser-html.html">MArgParser</a> to pull the values out then the plugin will behave just like the functions in maya.cmds.  Flags and arguments will be checked the same way that we're used to in the rest of Maya Python.  </p>
<p>Unfortunately, there's no law that says the plugin has to do it 'correctly'.  There are more than a few plugins that don't use the standard MSyntax/MArgParser combo and just pull values out of the argument list directly.  The most notorious offender is the FBX Plugin, which generates a ton of commands which all fail to use the standard parsing mechanism.  And, of course, there are also bits of MEL lying around from other sources as well that are a bit painful to call from Python, That's why you see tons of hairy beasts like this:      </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">maya.mel</span> <span class="kn">as</span> <span class="nn">mel</span>  
<span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexStart -v &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_frames</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>  
<span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexEnd -v &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">end_frames</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>  
<span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;FBXExport -f </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">get_export_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fbx</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>


<p>While this is workable, it's fragile: composing strings inline inside a function call is an invitation to bugs like forgetting an escaped quote (tell me you'd notice that last escape in the final line if it was borked!) or a bit of significant whitespace. It's also harder to meta-program anything that's written like this - you can't create a dictionary of options or a variable length list of arguments when you call the function. Last - but not least, at least not for lousy typists like myself - you can't rely on autocompletion in your IDE to make things quicker and less error prone.  </p>
<p>In cases like this it's handy to be able to fall back on a wrapper that will feed the plugin a correctly formatted MEL-style argument but which looks and codes like regular Maya Python. Luckily, you can usually rely on the MEL syntax, even when the plugin's argument parsing is as Python-unfriendly as the FBX plugins: If the MEL version doesn't work either, the whole thing isn't worth rescuing ! -- but if it does then you can Python-ify the front end with a little bit of Python magic to make sure the arguments are passed correctly.  </p>
<p>One thing we can do to make this a simple job is to use what's known as <em>MEL function syntax</em>.  This is a little-used MEL behavior that lets you call MEL more or less like a traditional computer function, rather than the shell-style script format you usually see. Function syntax uses parentheses and a comma-delimited list of arguments rather than white space. It means that these two calls are identical:  </p>
<div class="highlight"><pre><span></span>spaceLocator -p 1 2 3 -n &quot;fred&quot;;  
spaceLocator(&quot;-p&quot;, &quot;1&quot;, &quot;2&quot;,  &quot;3&quot;,  &quot;-n&quot;,  &quot;fred&quot;);
</pre></div>


<p>While you probably don't want to type that second one, it's a lot easier to manage if you're trying to turn a bunch of flags and arguments into a MEL command string.  What we'll be doing is creating a function that generates argument strings in the function syntax style and then passes them to MEL for you, allowing you to use the familiar cmds-style arguments and keywords instead of doing all the string assembly in-line with your other code.  </p>
<p>The rest of the relevant MEL syntax rules are pretty simple, with one exception we'll touch on later:  </p>
<ul>
<li><em>Everything</em> is a string!</li>
<li>Flags are preceded by a dash</li>
<li>Flags come first</li>
<li>Non-flag arguments follow flags</li>
<li>Multipart values are just a series of single values</li>
</ul>
<p>That first one may suprise you but it's true - and in our case it's extremely useful. If you're dubious, though, try this in your MEL listener:  </p>
<div class="highlight"><pre><span></span>polyCube (&quot;-name&quot;, &quot;hello&quot;, &quot;-width&quot;, &quot;999&quot;);
</pre></div>


<p>Implementing these rules in a function turns out to be pretty simple.   </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">maya.mel</span>  
<span class="k">def</span> <span class="nf">run_mel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  
    <span class="c1"># makes every value into a tuple or list so we can string them together easily  </span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">v</span><span class="p">,)</span>  
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>  
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>   
        <span class="n">output</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="s2">&quot;-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>  
        <span class="c1"># if the flag value is True of False, skip it   </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">**</span><span class="ow">in</span> <span class="p">(</span><span class="o">**</span><span class="bp">True</span><span class="o">**</span><span class="p">,</span> <span class="o">**</span><span class="bp">False</span><span class="o">**</span><span class="p">)</span><span class="o">**</span><span class="p">:</span>  
            <span class="n">output</span><span class="o">.</span><span class="n">extend</span> <span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>  
        <span class="n">output</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="n">quoted</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">maya</span><span class="o">.</span><span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">quoted</span><span class="p">,</span> <span class="n">output</span><span class="p">))))</span>
</pre></div>


<p>This function will correctly format a MEL call for almost all circumstances (see the note below for the exception).  For example the irritating FBX commands above become  </p>
<div class="highlight"><pre><span></span><span class="n">run_mel</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexStart&quot;</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">start_frames</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>  
<span class="n">run_mel</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexEnd&quot;</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">end_frames</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>  
<span class="n">run_mel</span><span class="p">(</span><span class="s2">&quot;FBXExport&quot;</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">get_export_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fbx&quot;</span><span class="p">)</span>
</pre></div>


<p>That's a big improvement over all that string assembly (not leastaways because it pushes all the string nonsense into one place where it's easy to find and fix bugs!)   However it's still a bit ugly. Wouldn't it be cleaner and more readable to nudge these guys another step towards looking like real Python?  </p>
<p>Luckily that's quite easy to do. After all, the run_mel("command") part of this is the same except for the command names. So why not make a second function that makes functions with the right command names?  This is basically just a tweak on the way decorators work. For example:  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mel_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">wrap</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  
        <span class="k">return</span> <span class="n">run_mel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">wrap</span>
</pre></div>


<p>This takes a MEL command name ("cmd") and makes a new function which calls run_mel using that command. So you can create objects which look and work like Python commands but do all the nasty mel stuff under the hood like this:  </p>
<div class="highlight"><pre><span></span>FBXExport = mel_cmd(&quot;FBXExport&quot;)      
FBXExportBakeComplexStart = mel_cmd(&quot;FBXExportBakeComplexStart&quot;)  
FBXExportBakeComplexEnd = mel_cmd(&quot;FBXExportBakeComplexEnd&quot;)
</pre></div>


<p>And call them just like real Python:    </p>
<div class="highlight"><pre><span></span><span class="n">FBXExport</span><span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="s2">&quot;this_is_a_lot_nicer.fbx&quot;</span><span class="p">)</span>
</pre></div>


<p>All this might seem like a bit of extra work -- and it is, though its not much more work than all those laboriously hand-stitched string concatenations you'd have to do otherwise.</p>
<p>More importantly, this actually is a case where code cleanliness is next to Godliness: keeping rogue MEL from invading your python code is a big boon to long term maintenance.  String assembly is notoriously bug prone: it's way too easy to miss a closing quote, or to append something that's not a string and bring the whole rickety edifice crashing down.  Moreover, exposing all of that stringy stuff to other code makes it impossible to do clever python tricks like passing keyword arguments as dictionaries.  So in this case, a little upfront work is definitely worth it.  </p>
<p>Plus, if you're lazy like me you can import these functions in a module and they'll autocomplete. Fat Fingers FTW!   </p>
<p>So, if you find this useful, the complete code is <a href="https://gist.github.com/theodox/9a2e2b92867fa82ea328">up on Github.</a>  </p>
<h3>Note</h3>
<p>If you're a real mel-head you may have noticed one limitation in the <code>run_mel()</code>implementation above.  MEL allows multi-use flags, for commands like  </p>
<div class="highlight"><pre><span></span>ls -type transform -type camera
</pre></div>


<p>However the function here doesn't try to figure format arguments that way. In part because it's a relatively rare feature in MEL, but mostly because it doesn't occur in the places I've needed to wrap MEL commands.  It would not be hard to extend the function so you could annotate some flags as being multi-use - if you give it a whirl let me know and I'll post it for others to see.  </p>
<h3>Bonus Round</h3>
<p>The <a href="https://gist.github.com/theodox/2b83b1c47a18448d3cbf">Github also has another module</a> which uses the same basic idea (but a slightly different code structure) to wrap that stupid FBX plugin.</p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Sun 26 October 2014
            </p>
<p>There are <a href="http://theodox.com/2014/maya_plugin_commands#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://theodox.com/2014/2015_bug_watch_ls" rel="bookmark" title="Permalink to 2015 Bug watch: ls()">
                <h2 class="post-title">
                    2015 Bug watch: ls()
                </h2>
            </a>
                <p>For people switching to Maya 2015 here's an irritating bug in the 2015 Maya python layer.  </p>
<p>In all Mayas before 2015 (as far as I can check, anyway), calling cmds.ls() with a string that was not a valid Maya object name was allowed. You could for example, call  </p>
<div class="highlight"><pre><span></span><span class="n">cmds</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
</pre></div>


<p>and you'd get back an empty array. In 2015, however, it looks like they have changed the way maya.cmds is converting the string into a dag node reference; it you call the same thing in 2015 you'll get this instead:  </p>
<div class="highlight"><pre><span></span><span class="c1"># Error: Syntax error: unexpected end @ at position 1 while parsing:  </span>
<span class="c1"># ; ; @  </span>
<span class="c1"># ; ; ^  </span>
<span class="c1"># : @  </span>
<span class="c1"># Traceback (most recent call last):  </span>
<span class="c1"># ; File &quot;&quot;, line 1, in   </span>
<span class="c1"># RuntimeError: Syntax error: unexpected end @ at position 1 while parsing:  </span>
<span class="c1"># ; ; @  </span>
<span class="c1"># ; ; ^  </span>
<span class="c1"># : @ #</span>
</pre></div>


<p>This is a bit more serious than it seems at first glance, because ls is such a common command. Any ls operation which includes a string that starts with anything other than a letter or a number with raise an exception, so there are a lot of places which used to just chug along silently that are going to start raising exceptions.  </p>
<p>My workaround is to patch cmds.ls on startup so that it safely renames any bad string before passing them to Maya.  I do this in my bootstrap routine so I don't have to chase down every occurrence of ls anywhere in my code  (1,001 of them, or so PyCharm tells me...).  </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>  
<span class="kn">import</span> <span class="nn">maya.cmds</span> <span class="kn">as</span> <span class="nn">cmds</span>

<span class="n">VALID_OBJECT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;^[|]?([^a-zA-Z_\?\*\:\|])|([^a-zA-Z0-9_\?\*\:\|\.\[\]])&quot;&quot;&quot;</span><span class="p">)</span>  
<span class="n">as_u</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;addPrefix&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_ls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  
    <span class="sd">&#39;&#39;&#39;  </span>
<span class="sd">    Patches maya 2015 cmds.ls so that it does not except when passed illegal name characters.  </span>
<span class="sd">    &#39;&#39;&#39;</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>  
        <span class="k">return</span> <span class="n">_BASE_LS</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>  
       <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">test_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">VALID_OBJECT</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">as_u</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>  
    <span class="k">return</span> <span class="n">_BASE_LS</span><span class="p">(</span><span class="n">test_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="n">gs</span><span class="p">)</span>

<span class="n">cmds</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="n">safe_ls</span>
</pre></div>


<p>This makes sure that existing code works as it did before and I don't <em>think</em> it will break anything, since the invalid character strings were never going to be ls'ed into anything anyway.  Ordinarily I'm not a big fan of magical behind the scenes fixes but this is a pretty serious change to the behavior of ls which doesn't seem like an intentional upgrade so much as an oversight on Autodesk's part. So, at least until the old behavior comes back I'm gonna try it.  </p>
<p><em><strong>Update:</strong> Hat tip to +Robert White for pointing out that the original regex I posted did not handle namespaces. Code above includes the fix.  Never would have figured it out without <a href="https://pythex.org/">Pythex!</a></em>  </p>
<p><em><strong>Update 2:</strong> Updated the <code>safe_ls</code> procedure to handle more of the allowable syntax in older mayas</em>  </p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Thu 04 September 2014
            </p>
<p>There are <a href="http://theodox.com/2014/2015_bug_watch_ls#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://theodox.com/2014/size_is_the_enemy" rel="bookmark" title="Permalink to Size is the enemy: an oldie but a goodie">
                <h2 class="post-title">
                    Size is the enemy: an oldie but a goodie
                </h2>
            </a>
                <h2>#1: Maintain &gt; Build</h2>
<p>Maintaining any codebase is way harder than making it. Waaaaaay harder.  </p>
<p>I've been presiding over a rewrite of my own toolset - one that is only 2.5 years or so of my own work - and I'm amazed and appalled at how crufty it is. Lots of important things are held together with spit and bailing wire. Lots of trivial things are massively over-engineered. And -- though I pride myself on being good about code reuse, _there's-only-one-way-to-do-it, _and extending earlier solutions instead of reinventing things -- it's full of pointless duplication.   </p>
<p>And even though it's 90% my own work it's full of conflicting style choices and paradigms.  I guess it shows I'm still learning, so I haven't gotten totally stale yet.  </p>
<h2>#2: Dynamic &gt; Static</h2>
<p>I've been looking a lot at possible language alternatives to Python for future tools. I love Python. I mean, in a totally unhealthy, creepy, even stalker-y way. But I don't like being to beholden to any one tech or approach. I'd love to get beyond Python's erratic distribution mechanisms, and Id' <em>really</em> like to get my hands on a decent GUI toolkit that didn't make me program C++ indirectly ( <a href="http://shoesrb.com/">Python Shoes</a>, where are you?)  </p>
<p>So, while tinkering with <a href="http://boo.codehaus.org/">Boo</a>, <a href="http://cobra-language.com/">Cobra</a>, <a href="http://nimrod-lang.org/documentation.html">Nimrod </a>and a few other options I've been revisiting the old theological debate about dynamic vs static languages; working on <a href="http://moonrise-game.com/">Moonrise </a> (in Unity) has made me realise that C# was designed with the express intention of driving me insane. It seems routinely true that I write 4 times as many lines of C# as I do in Python. I'm sure I'm saving a few bugs because of all the clunky type management stuff, but I think I'd rather just fix the bugs than suffer through the oceans of boilerplate that C# induces.   </p>
<p>To be fair, it's a little worse in Unity than in the rest of the world: you can do a lot to make C# suck less using attributes and reflection and other meta-techniques, but those are tougher to do in Unity's special flavor of C#.   </p>
<p>Still, I think I've finally made up my mind on this one: I'd rather take the risks that come with dynamic code over the sheer, mind-numbing boredom that comes with obsessive type safety.  Especially in a world where overhauling and updating and refactoring code is the <em>real</em> work: building it is just the first chapter.  </p>
<h2>#3 I hate curly braces.</h2>
<p>I'm not even trying to deny it anymore. I hate the little bastards.  What a waste of space.  </p>
<h2>#4  I'm Screwed</h2>
<p>The interesting problem - if I end up just getting cozy with my prejudices and preferences - is now how to pick a decent dynamic environment for tools development while (A) not having the code base degenerate into mush and  (B) having decent GUI options.   And if at all possible, (C), no goddam curly brackets.  </p>
<p>For most of my work - managing files, talking to databases, and dealing with data on disk performance is not really the most important problem: I tend to deal in minute-scale problems not hour-scale problems, so cutting them down by a factor of 5 is a nice plus rather than a live-or-die necessity.  While this means a bit more freedom, it also removes a sorting criterion from the problem.  </p>
<p>The stinky part is that, for the given problem set there really is <strong>no obvious winner</strong>.  </p>
<ul>
<li>I could imagine that the combination of <a href="https://www.ruby-lang.org/en/">Ruby </a>and <a href="http://shoesrb.com/">Shoes</a> would be super productive, even though the Shoes GUI is pretty limited compared to QT or WPF.  I could probably tolerate those block ending markers in Ruby, and there is a good set of standard library code out there. The perf is not great but that's my least important problem. I don't think it's much easier to distribute Ruby apps to users than it is to do with Python, however.</li>
<li>Nimrod looks like a cool little language, but has no equivalent of the Python standardlib.</li>
<li>
<p>Boo and Cobra both use the same CLR as C#, so theoretically you can use them to drive GUI apps with WPF or winforms, but that puts you right back into programming a clunky language through the medium of a nicer one: if I wanted that I'd stick with PyQT.  </p>
</li>
<li>
<p>Javascript is actually super powerful, in the sense that has the same kind of high level fluidity that Python does. It's also got the best (or at least the most broadly available and flexible) GUI out there in the form of  HTML + CSS. Unfortunately it's got the security sandbox so you need a special infrastructure to do even really mundane stuff like trolling the files on a hard disk -- to say nothing of it's famously bad issues with local vs global variables and scoping.  <a href="http://coffeescript.org/">CoffeeScript</a> can eleminate a lot of the worst syntactic pain (and the blankety-blank curly brackets) but it's hard to maintain code which is written in one language but actually <em>run</em> in another: "compiles to Javascript" is pretty cool until you have to actually debug something which is only genetically related to the code you actually <em>wrote.<br />
</em></p>
</li>
<li>
<p>(update 9/3) You can do an HTML front end for a python app with the <a href="https://code.google.com/p/cefpython/">Chromium Embedded Framework for python</a>. That actually works pretty well, and lets you keep JS for the light weight UI manipulation while passing the heavy lifting off to Python fairly transparently. The only caveat: the day after I discovered this I went to work, installed the Maya 2015 trial -- and promptly found that <em>their</em> shiny new HTML gui front end had a Javascript error and did not work, thereby preventing me from logging iu to the trial. It's the new thing altight, but it's not quite there.  And It's still a 2-language solution, albeit a nice one.  </p>
</li>
<li>
<p>(update 9/3):  For completeness sake I should mention the combination of Jytron and AWT or Swing. This works right out of the box - if you have Jython, you have a complete GUI toolkit with no downloads, installs or DLLs to manage. You can also <a href="http://stackoverflow.com/questions/16701979/packaging-a-jython-program-in-an-executable-jar">compiile Jython to executables</a>, buit it's not a completely transparent process and it seems a bit fiddly. Still, could be an optiom....  </p>
</li>
<li>
<p>(ipdate 9/3)::  I've also been experimenting a lot with compiling IronPython to exes using the IL compiler that comes with IronPython. So far it actually looks pretty good: the exes are smaller than similar Py2Exes or PyInstaller projects and they seem to be less prone to obscure compilation problems too.... maybe some light at the end of the tunnel?</p>
</li>
</ul>
<p>_<strong>TLDR: </strong> _There really is nothing that fills the niche of a powerful, flexible language with good GUI and distribution options right now.  Sigh.  </p>
<p>Please, prove me wrong !</p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Mon 01 September 2014
            </p>
<p>There are <a href="http://theodox.com/2014/size_is_the_enemy#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://theodox.com/2014/python_str_format_cookbook" rel="bookmark" title="Permalink to Handy link: Python string format cookbook">
                <h2 class="post-title">
                    Handy link: Python string format cookbook
                </h2>
            </a>
                <p>If you're like me and addicted to using the old-school percent-symbol based string format, the newer bracket-based formatting is probably a bit mysterious. The <a href="https://docs.python.org/2/library/string.html#format-specification-mini-language">python docs</a> certainly don't help, they seem to be written for C programmers on meth (a help document entitled 'string format specification mini language' does not scream 'usability' to me, at any rate).  </p>
<p>So, many props to Marcus Kazmierczak for his handy <a href="http://mkaz.com/2012/10/10/python-string-format/">Python String Formatting Cookbook</a> page. It's already saved me a ton of profanity. Here's to elevating the discourse of the internet!</p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Wed 09 July 2014
            </p>
<p>There are <a href="http://theodox.com/2014/python_str_format_cookbook#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://theodox.com/2014/subtle_bug" rel="bookmark" title="Permalink to From the annals of bug subtlety">
                <h2 class="post-title">
                    From the annals of bug subtlety
                </h2>
            </a>
                <p>From the annals of the truly screwed up comes an object lesson in why <strong>it's really nice to have a debugger</strong>.</p>
<p>I'm porting a biggish python codebase to support multiple OSs  and maya versions.  As I move things around I try to use the opportunity to shore up test coverage.  And it always feels like the most boring chore imaginable, until something like this crops up.</p>
<p>I've got an exporter framework that I share between projects and files, and I have to move it from Maya 2011-only to support multiple versions.  It's important code, so it's tested - but the test is really dumb: it creates a test scene, imports the test framework, and calls one function. </p>
<p>But, for some reason, running the tests in 2014 never works - even though I can manually execute the exact steps in a regular copy of maya and all is well.</p>
<p>So I threw it under the debugger -- <a href="http://www.jetbrains.com/pycharm/">_PyCharm FTW!__</a> -- and started stepping through. No dice, everything seemed OK but still the test failed: it could not find my test objects. Finally, in desperation, I started stepping though the test and issuing an ls() after every step... and I found that the break wasn't caused by running code - it was caused by importing my module.  I didn't call it - just <em>imported</em> it.  WTF?</p>
<p>It turns out that <em>importing PyMel was wiping my test scene</em> in 2014! The tests all run under maya.standalone, and the bug only shows up there, which is why just doing it by hand in maya wasn't showing the same symptoms.</p>
<p>Here's my repro case:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">maya.cmds</span> <span class="kn">as</span> <span class="nn">cmds</span>
<span class="n">cmds</span><span class="o">.</span><span class="n">polyCube</span><span class="p">()</span>
<span class="c1"># [u&#39;pCube1&#39;, u&#39;polyCube1&#39;]</span>

<span class="n">cmds</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
<span class="c1"># [u&#39;front&#39;, u&#39;pCube1&#39;, u&#39;persp&#39;, u&#39;side&#39;, u&#39;top&#39;]</span>

<span class="kn">import</span> <span class="nn">pymel.core</span> <span class="kn">as</span> <span class="nn">pm</span>
<span class="n">cmds</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;transform&#39;</span><span class="p">)</span>
<span class="c1"># [u&#39;front&#39;, u&#39;persp&#39;, u&#39;side&#39;, u&#39;top&#39;]</span>
</pre></div>


<p>This is a 100% repro in maya.standalone - but <em>not</em> in GUI maya, where the bug does not occur.</p>
<p>Is this true for everybody else?  </p>
<p>The workaround is to import pymel earlier so that the destruction doesn't affect anything important. </p>
<p>But... <strong>ouch!</strong></p>
<p><img alt="" src="http://i0.wp.com/www.therefinedgeek.com.au/wp-content/uploads/2013/09/Picard-Facepalm.jpg" />  </p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Fri 20 June 2014
            </p>
<p>There are <a href="http://theodox.com/2014/subtle_bug#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://theodox.com/2014/save_the_environment" rel="bookmark" title="Permalink to Save the environment!">
                <h2 class="post-title">
                    Save the environment!
                </h2>
            </a>
                <p><a href="https://plus.google.com/112207898076601628221">+Rob Galanakis</a>  posted this on Google+, and as I started to reply I realized this would be a useful thing to put out to a wider audience.  Or maybe useful isn't the right word - it's just something that bugs me so I want to bloviate about it.  </p>
<blockquote>
<p>Hey +Cory Mogk , +Brad Clark, +Steve Theodore , and whoever else in #techart . Has anyone figured out a viable model for reusing Python libraries in Maya, like other Python applications with pip/virtualenv/requirements.txt do? Is there a conversation anywhere?﻿</p>
</blockquote>
<p>The short answer to Rob's question is : I've tried to go this route, but I couldn't get a virtualenv-based approach to match for my needs.   For the long answer, read on...  </p>
<h2>If You're Not Outraged, You're Not Paying Attention</h2>
<p>Like <a href="http://lucumr.pocoo.org/2014/1/27/python-on-wheels/">a lot of people</a>, I'm pretty unhappy about <a href="http://www.simplistix.co.uk/presentations/python_package_management_08/python_package_management_08.pdf">the state of python environment management</a>.   </p>
<p><a href="http://www.faithvillage.com/files/galleries/acf1e1575cba5c2dcbb9966017bab1622c3bfee9-7aaec91bedc07579a475225ff6467f07/thumbs/acf1e1575cba5c2dcbb9966017bab1622c3bfee9-7aaec91bedc07579a475225ff6467f07-hero_image-resize-260-620-fill.jpg"><img alt="" src="http://www.faithvillage.com/files/galleries/acf1e1575cba5c2dcbb9966017bab1622c3bfee9-7aaec91bedc07579a475225ff6467f07/thumbs/acf1e1575cba5c2dcbb9966017bab1622c3bfee9-7aaec91bedc07579a475225ff6467f07-hero_image-resize-260-620-fill.jpg" /></a></p>
<p>There's no dependable, low-maintenance way for people to distribute things -- or to cleanly install things that depend on other things. Even the best tools are wonky, jacked up scaffolding on layers of older, crummier code.  </p>
<p>The boundaries of any particular piece of Python are porous to begin with, both because of cross imports and also python's magical morphing and monkey patching abilities - but the messy state of the distribution ecosystem makes things far worse than they should be. Figuring out how to correctly set up a new module in this ambiguous environment is treacherous. It's not for nothing that the "easy" installation tools, pip and easy_install between them have 17,000+ questions on StackOverflow!  </p>
<p>The typical <a href="http://stackoverflow.com/questions/4750806/how-to-install-pip-on-windows">easy_install / pip route</a> is tolerable, more or less, if you're coder, and you live in a *nixy everybody-is-a-coder and everybody-has-a-compiler environment. When you're busy experimenting with different frameworks and shiny new toys that show up on <a href="https://pypi.python.org/pypi">the cheeseshop</a>, it's great to get all that cool free stuff with just a a few keystrokes.  But this is "easy" only in the sense that hand editing config files to set up a web server is "easy": if you're technically confident, willing to debug anomalies, and have enough background knowledge to sort of the hiccups you'll be fine. But that's not "easy" for 99% of humanity, that's easy for hardcore nerds.   </p>
<p>The Python distribution ecosystem just isn't... well... Pythonic.  It embarrassingly fails the <a href="http://legacy.python.org/dev/peps/pep-0020/">pythonic principle</a>  </p>
<div class="highlight"><pre><span></span>There should be one-- and preferably only one --obvious way to do it.
</pre></div>


<p>since there are <a href="http://stackoverflow.com/questions/6344076/differences-between-distribute-distutils-setuptools-and-distutils2">at least 4 big toolsets</a> (setuptoools, distutils, distribute and distribute 2) and none of them is perfect. All rely on a mixture of static data and scripts that react to the state of your local machine, so installing stuff can provide different results from different orders of operation or different environment settings.  It also fails both  </p>
<div class="highlight"><pre><span></span>    Simple is better than complex.
</pre></div>


<p>and     </p>
<div class="highlight"><pre><span></span>    Complex is better than complicated.
</pre></div>


<p>Since the operations you need to perform are often obscure and obscurely interdependent.  Even on a mac, which (being *nixy) should be a much friendlier environment for the live-install approach, I've had serious nightmares -- <a href="http://techartsurvival.blogspot.com/2013/12/and-i-thought-we-had-it-bad.html">trying to set up Django was like a &amp;!*^#&amp;^$ Kafka novel.</a>  To some degree my bad luck there reflects failure to live up to  </p>
<div class="highlight"><pre><span></span>    In the face of ambiguity, refuse the temptation to guess.
</pre></div>


<p>because many of the problems come from a welter of competing installation scripts and tools that are constantly trying to make things "easy" for one application in ways that make them harder for others.  </p>
<p>To be fair, the Python universe is so diverse that it's almost beyond the possibility of rational management : a big product like <a href="http://plone.org/documentation/manual/upgrade-guide/version/upgrading-plone-4.2-to-4.3/updating-package-dependencies">Plone </a>can involve literally hundreds of dependencies including a mix of python and compiled code that has to run on dozens of platforms.  Even if 99% of them install flawlessly, the remainders still add up to (at best ) a long, frustrating afternoon of  head-scratching, doc-reading forensics.  It's DLL hell all over again.  </p>
<p>It's enough to make you long for a blankety-blank InstallShield wizard.   </p>
<p>On the receiving end, things are just as confusing and intimidating.  Because Python is so multi-platform, lots of packages expect you to be able to compile your own binaries, which is rarely a trivial undertaking even for coders (at least, for people who don't do much non-python programming) and is petrifying for end users. More dangerous, though, is the fact that not everybody does a great job of tracking their own dependencies or knowing their own requirements.  If package X will works with version 2.1 of package Y, but not with 2.2  upgrading Y to 2.35 will break X.  And  of course Y 2.35 might have come along after the author of package X has moved on to other projects.  And Y 2.2 may be required by package Z, and get upgraded automatically when you grab Z to check it out.  </p>
<p>All of this puts us in the rotten position where installing something new has the potential to break existing code. The user is the one who has to figure that out and work around it, and the fix is often "you can't do this and that in the same install unless you write a patch yourself."   </p>
<p><a href="https://pip.readthedocs.org/en/1.0.1/">pip</a> and <a href="http://stackoverflow.com/questions/6344076/differences-between-distribute-distutils-setuptools-and-distutils2">buildout</a> do a heroic job of trying to organize all this chaos. However the underlying problem is _extremely _hard, because the foundations are shaky. You've got decades' worth of code, full of shadowy, hard-to-track dependencies, made by hundreds of different hands with widely varying levels of care and forethought.  The  requirements for packages may not even be clear to their authors: do you know every nuance of the version differences in the packages you rely on? Do you always know when you're exploiting a behavior that the developers don't like and want to change?   </p>
<p>Hell, I cannot honestly say that for my <em>own</em> code all the time.  </p>
<p>The short version of all this: being able to install stuff is not the same as maintaining a healthy environment.  Just ask all your older relatives whose machines sport seventeen different internet toolbars.  </p>
<h2>Habitat Crisis!</h2>
<p>If that all sounds bad... well, in the technical art / Maya context, it's <em>worse</em>.  For a couple of reasons:  </p>
<p><a href="http://rlv.zcache.com/habitat_for_two_manatees_bumper_sticker-r4dabf424d562476183df7d3644afd8f8_v9wht_8byvr_512.jpg"><img alt="" src="http://rlv.zcache.com/habitat_for_two_manatees_bumper_sticker-r4dabf424d562476183df7d3644afd8f8_v9wht_8byvr_512.jpg" /></a></p>
<p>First, and most importantly, artist users are aren't going to accept a "real" command-line-and-text-file based system on their own, even if we had one. That means the TAs have to do it ~~automagically~~ remotely, which is a non-trivial tech challenge.  All too often 'remote installation' translates to 'send some poor sucker running around typing stuff for the artists while they everybody stands around waiting to get back to work.'   And wait till the next big update happens when somebody's on vacation; suddenly they're out of sync with the rest of the team and generating weird issues that are hard to debug. A first class ticket to 'It works on my machine' land!  </p>
<p>All tech support is made more difficult by a diversity of environments: that's why console games are easier to make than PC games even though the underlying tech is the same.  Asking your artists to maintain their own Python ecosystem is like asking your teenage kids to clean their rooms: if they do it at all, it won't be done that well enough to justify the arguing you need to get it done at all. It's hard enough to get a big art team to stay in sync with simple stuff like 'always get latest in perforce' or 'set this environment variable'.   So... managing a complex programming environment?  </p>
<p>In a shell window?  </p>
<p><em>Seriously?</em>  </p>
<p>To some degree this is a moot point: no matter your preferences, you might not have the kind of access you need to use python's admin level tools anyway.  If you have to work with outsourcers, as I do,  you don't have the option of ~~forcing your users at gunpoint~~ empowering your users to manage their own setups. In a lot of places (China especially) you can't count on the end user having admin privileges (thus, no writing into the Maya directory) or always-on internet access (thus, no pip/easy_install).   </p>
<p>Even if you have the rights, it might not be a good idea.  Outsource teams don't like having to reconfigure their whole workspace to accommodate a client who is here today and gone tomorrow. They want a clean, disposable, drop-in setup that they can turn on and off quickly.  A nice discrete footprint removes a lot of hassle from the relationship.  Done properly, it also saves a lot of remote support time and money.  Simplicity pays.  </p>
<p>That's true even for pure in-house development: any company that supports multiple teams needs the same flexibility to swap out toolsets easily without going deep into machine- or user-level configuration. At work I have people hopping between two or three distinct toolsets during an ordinary day, and it's vital that they can do this without wasting time or thought on how things like setting setting all sorts of environment variables or remembering to launch Maya from the right command line.  </p>
<h2>Save the Endangered Pythons!</h2>
<p><a href="http://www.kingsnake.com/blog/uploads/zombie.JPG"><img alt="" src="http://www.kingsnake.com/blog/uploads/zombie.JPG" /></a></p>
<p>All this adds up to a some pretty stark requirements for Maya python tools:  </p>
<ol>
<li>You want a Python environment that's uniform for all your users</li>
<li>You want to be able to have more than one environment side by side</li>
<li>You want your environments to be easy to distribute - and easy to delete </li>
</ol>
<p>In the wider Python world, this would automatically make you think <a href="https://pypi.python.org/pypi/virtualenv">virtualenv</a><em>.</em>  </p>
<p><a href="https://pypi.python.org/pypi/virtualenv">virtualenv</a> is the most popular solution to the messy round-robin of versioning, dependency management, and distribution.  While it's all sorts of sophisticated under the hood (here's some <a href="http://blip.tv/pycon-us-videos-2009-2010-2011/pycon-2011-reverse-engineering-ian-bicking-s-brain-inside-pip-and-virtualenv-4899496">details here</a>) it's conceptually very simple: cut all the crap and just make a separate Python for every project, containing exactly what we need!  Throw in <a href="http://www.dabapps.com/blog/introduction-to-pip-and-virtualenv-python/">pip </a>- the best-of-a-bad-lot installer tool that makes installing new modules as good as it's likely to get - and you can quickly create and populate lots of clean environments and populate them. Or use <a href="http://www.buildout.org/en/latest/">buildout </a>to create precisely controlled setups that have exactly what you need this time.  It's brilliant, Gordian-knot-cutting solution that replaces the incredible complexity of package management tools --  albeit at the cost of lots of duplicated code on disk. Disk space, however, is far cheaper than debugging time and tech-support hand holding.  </p>
<p>Unfortunately, I've never been able to figure out how to get a running Maya to use a virtualenv at runtime. The Maya application appears to be it's own python interpreter (you can verify this by checking _sys.executable _in your command window, or just by renaming mayapy.exe and noting that Maya still works fine).  Which means that virtualenv's main trick -- recursing up from the physical location of the python executable -- isn't going to work correctly.  We don't want to try copying Maya itself and all of it's zillions of dependencies  -- a hefty half-gigabyte or so --for every new project.  And even if we do, the licensing engine does actually care if you're running from the default install directory (at least, it's never let me get away with copying maya to a new location even on a licensed machine).  </p>
<p>Effectively, Maya already <em>is</em> it's own virtualenv . That's why you can have other versions of Maya running independently of other Pythons installed on your machine.  Which is nice and all  -- but no help for the problem of creating a cleanly isolated toolsets for your Maya users.  </p>
<p><a href="http://rlv.zcache.com/our_product_use_sustainable_buzzwords_bumper_sticker-r2e739ef8d9874e7f90d354212bf488aa_v9wht_8byvr_324.jpg"><img alt="" src="http://rlv.zcache.com/our_product_use_sustainable_buzzwords_bumper_sticker-r2e739ef8d9874e7f90d354212bf488aa_v9wht_8byvr_324.jpg" /></a></p>
<p>After banging my head against this for a while - I'm <a href="http://stackoverflow.com/questions/16678334/virtualenv-and-maya">not the only one who's tried it</a> - I've switched to a tactic that has most of the same properties as the virtualenv but is more Maya-friendly.  I try to replicate the same level of isolation with a rather higher level of uniformity (OK, let's be honest here: I mean <em>fascistic control</em>) over what my users get.  </p>
<p>While I'm not convinced its the distribution system to end all systems, I'm fairly happy with it - it's definitely been the least troublesome, lowest maintenance setup I've administered over the years, and it's worked pretty reliably for me both in and out of house.  I'll describe it a soon-to-be-completed followup post.  </p>
<p>In the meantime, allow me to say that looking at lots of bumper stickers while seeking funny graphics for your blog is a speedy way to dim your faith in humanity. <em>Not recommended.</em>  </p>
<p><a href="http://rlv.zcache.com/im_not_cynical_im_just_experienced_bumper_sticker-rf1ba55c5e6df4016859176f200d32d0f_v9wht_8byvr_324.jpg"><img alt="" src="http://rlv.zcache.com/im_not_cynical_im_just_experienced_bumper_sticker-rf1ba55c5e6df4016859176f200d32d0f_v9wht_8byvr_324.jpg" /></a></p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Tue 03 June 2014
            </p>
<p>There are <a href="http://theodox.com/2014/save_the_environment#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://theodox.com/2014/python_is_awesome" rel="bookmark" title="Permalink to Your weekly moment of Python-is-awesome">
                <h2 class="post-title">
                    Your weekly moment of Python-is-awesome
                </h2>
            </a>
                <p>I stumbled across a cool little idea while working on a refactor of my python tools build system, and although it is not really ready for prime-time it's fun enough I had to share.  With a little bit of work you can <em>load Python modules directly over the web via http!</em>  How cool is that?  </p>
<p>In the past I've always gave users a userSetup.py which automatically downloads a zip file containing all the rest of my code from a net share. While this works quite well, the userSetup file itself is a bit of a weak link. Although it changed pretty rarely, it was a bit more complex than I liked. In an ideal world, the user setup would be just a couple of lines, highly resistant to breakage and easy to leave untouched for months or years.  All the changeable stuff should happen off in the ether, so users always get the latest hotness.  </p>
<p>While pondering how to improve this, I was trolling Doug Hellman's invaluable <a href="http://pymotw.com/2/">Python Module of the Week</a> site and stumbled onto his discussion of <a href="http://pymotw.com/2/sys/imports.html">custom Python module finders</a>. Basically, a module finder is a class which you can register with python to tell it how to look for modules. The key word there is 'how', not where' -- a module finder can do anything it wants to find or create a module, as long as it has returns an object with a load_module method that python can use to actually pop the code into sys.modules. It's particularly cool because the process is <em>completely transparent</em> to the calling code: if you call  </p>
<p><code>import XXX</code>  </p>
<p>you'll get XXX, even if your custom finder/loader had to generate it by consulting the _I Ching _and waiting for the right phase of the moon.  </p>
<p>That sounds like fun (jeez, my sense of fun has gotten pretty esoteric). So, I hacked up a highly experimental example of a module loader that will look on the web for a python module being served up via http and import it as if it were local.  </p>
<p>Here's the first bit, the module finder which is in charge of looking for the code when somebody says <code>import xxx</code>:  </p>
<div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;  </span>
<span class="sd">web_shim.py</span>

<span class="sd">Exposes a custom module loader and importer which allow for download, cache and  </span>
<span class="sd">load of python modules stored on an HTTP server</span>

<span class="sd">To activate, add the class to sys.path_hooks:</span>

<span class="sd">    sys.path_hooks.append(WebFinder)  </span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">imp</span>  
<span class="kn">import</span> <span class="nn">sys</span>  
<span class="kn">import</span> <span class="nn">urllib2</span>  
<span class="kn">import</span> <span class="nn">binascii</span>  
<span class="kn">import</span> <span class="nn">os</span>  
<span class="kn">import</span> <span class="nn">tempfile</span>


<span class="k">class</span> <span class="nc">WebFinder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  
    <span class="sd">&#39;&#39;&#39;  </span>
<span class="sd">    A custom module finder (background: http://pymotw.com/2/sys/imports.html)  </span>
<span class="sd">    that will find and load modules via http connections, as long as the  </span>
<span class="sd">    module file&#39;s parent http path is on the system path</span>

<span class="sd">    The module file is downloaded to the users temp directory. When it changes, it  </span>
<span class="sd">    will be replaced with the latest version from the server. Returns a WebLoader  </span>
<span class="sd">    for the cached file.  </span>
<span class="sd">    &#39;&#39;&#39;</span>  
    <span class="n">CACHE_DIR</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_entry</span><span class="p">):</span>  
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;http&quot;</span> <span class="ow">in</span> <span class="n">path_entry</span><span class="p">:</span>  
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">()</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">path_entry</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CACHE_DIR</span><span class="p">)</span>  
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  
        <span class="n">expanded</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">fullname</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span><span class="p">))</span>  
        <span class="k">try</span><span class="p">:</span>  
            <span class="n">target_url</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fullname</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span><span class="p">)</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">target_url</span> <span class="o">=</span> <span class="n">target_url</span>  
            <span class="n">dl</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">target_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
            <span class="n">crc</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>  
            <span class="n">old</span> <span class="o">=</span> <span class="mh">0xffffffff</span>  
            <span class="k">try</span><span class="p">:</span>  
                <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span>  
                <span class="n">disk_date</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
                <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
                <span class="n">old</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">crc32</span><span class="p">(</span><span class="n">disk_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>  
            <span class="k">except</span><span class="p">:</span>  
                <span class="n">old</span> <span class="o">=</span> <span class="mh">0xffffffff</span>  
            <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="n">old</span><span class="p">:</span>  
                <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">expanded</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span>  
                <span class="n">handle</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span>  
                <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
            <span class="k">return</span> <span class="n">WebLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_url</span><span class="p">,</span> <span class="n">expanded</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>  
        <span class="k">except</span><span class="p">:</span>  
            <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">expanded</span><span class="p">)):</span>  
                <span class="k">return</span> <span class="n">WebLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_url</span><span class="p">,</span> <span class="n">expanded</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>
</pre></div>


<p>The module finder's job is to be pointed at a path (in this case, 'self.url') If the path is not something this finder knows how to handle, it raises an ImportError. Otherwise, it sticks around until Python calls find_module with a module name, at which point it will return a module loader object (see below) or None if it doesn't know what to do.  </p>
<p>In this case, we do everything as simply as possible. The finder only works on a path with 'http' in it (note that's not really the right way to check for a url! It's enough for proof of concept, though). The finder just fills out the path with the name of the module (plus ".py") and tries to download it into the user's temp directory. The business with the hex numbers is just a crc check to make sure that the downloaded module is the latest version. If this is the first time you've grabbed the file -- or if the code on the server has changed  -- the cached copy will be refreshed.  </p>
<p>The second half of the operation is the WebLoader, which loads the cached module:  </p>
<div class="highlight"><pre><span></span><span class="c1"># usess the same imports as WebFinder.py</span>

<span class="k">class</span> <span class="nc">WebLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  
    <span class="sd">&#39;&#39;&#39;  </span>
<span class="sd">    Import loader (see http://pymotw.com/2/sys/imports.html for background)  </span>
<span class="sd">    which loads modules cached by a WebFinder using imp.load_source  </span>
<span class="sd">    &#39;&#39;&#39;</span>  
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">filepath</span>  
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">load_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>  
        <span class="k">if</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>  
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span>  
            <span class="k">return</span> <span class="n">mod</span>  
            <span class="c1"># bail now so we don&#39;t mislead users  </span>
            <span class="c1"># if mod was found somewhere else!  </span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_source</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>  
            <span class="n">mod</span><span class="o">.</span><span class="n">__file__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>  
            <span class="n">mod</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">fullname</span>  
            <span class="n">mod</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">]</span>  
            <span class="n">mod</span><span class="o">.</span><span class="n">__loader__</span> <span class="o">=</span> <span class="bp">self</span>  
            <span class="n">mod</span><span class="o">.</span><span class="n">__package__</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fullname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  
            <span class="k">return</span> <span class="n">mod</span>
</pre></div>


<p>A moduleloader can do all sorts of fancy things (the test code on PyMOTW, for example, loads a module from a python shelf database) but in this case I'm doing the simplest thing possible, which is to use imp.load_source on our cached python file. imp, if you're not familiar with it, is a super useful built-in module which provides access to most of the internals of python's import process). Actually using the code is the cool part. All you need to do is to register the finder with sys.path_hooks and then add the web server with your modules on in to your path:   </p>
<div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">path_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WebFinder</span><span class="p">)</span>  
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;http://www.inference.phy.cam.ac.uk/mackay/python/compression/huffman&quot;</span><span class="p">)</span>

<span class="c1"># with the url on the path, just use import  </span>
<span class="kn">import</span> <span class="nn">Example</span>  
<span class="k">print</span> <span class="n">Example</span><span class="o">.</span><span class="n">__path__</span>  
<span class="c1">#[&#39;http://www.inference.phy.cam.ac.uk/mackay/python/compression/huffman/Example.py&#39;]</span>

<span class="c1"># the module&#39;s __path__ will point at the url, but __file__ points at the cached  </span>
<span class="c1"># file on disk</span>
</pre></div>


<p>This isn't really something I'd be comfortable using in production without more work.  There's no security and no authentication, so not only is your code up on the web for anybody to see, you're also executing code off the web with no idea what it will do. It would be OK for an intranet if you were pretty sure none of your coworkers fancies him/herself a master prankster, but I'd slather on the security before trying this over long distances!  </p>
<p>Another obvious improvement would be to figure out a how to diff the local version of the file against the version on the http server without actually downloading the whole thing; that would be simple if the server could be asked for the CRC directly, but it would mean a tighter coupling between the finder and the server (which might be a good thing, security wise).  Another improvement might be to hack the loader so it force reloaded the module if the server version had changed, although that could have unintended side effects.</p>
<p>The point, however -- assuming there is one --  is how freaking awesome python's infrastructure is. Live loading of code over the net, transparent to all your other code, in about 50 lines?  Hats off to Guido.   </p>
<p><a href="http://www.wired.com/wp-content/uploads/blogs/wiredenterprise/wp-content/uploads/2012/06/beard-programmers-final-two.png"><img alt="" src="http://www.wired.com/wp-content/uploads/blogs/wiredenterprise/wp-content/uploads/2012/06/beard-programmers-final-two.png" /></a></p>
            <p class="post-meta">Posted by
                    <a href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
                 on Tue 27 May 2014
            </p>
<p>There are <a href="http://theodox.com/2014/python_is_awesome#disqus_thread">comments</a>.</p>        </div>

    <hr>
    <!-- Pager -->
    <ul class="pager">
        <li class="next">
                <a href="http://theodox.com/tag/programming4.html">Older Posts &rarr;</a>
                <a href="http://theodox.com/tag/programming2.html"> &larr; Newest Posts</a>
        </li>
    </ul>
    Page 3 / 5
    <hr>
            </div>
            <!---- right sidebar -->
            <div class="col-lg-2 col-md-1">
                <div class="vertical-spacer">
                <h4>@social</h4>
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://www.linkedin.com/in/stevetheodore">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/theodox">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://plus.google.com/u/0/+SteveTheodore480BC/posts">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-google fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://stackoverflow.com/users/1936075/theodox">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
                
                </div>
                <div class="vertical-spacer">
                <h4>#tags</h4>
                    <a href="/tags">tag list</a>
                    
                        <a class="tag-link" href="http://theodox.com/tag/animation.html">animation</a>
                        <a class="tag-link" href="http://theodox.com/tag/api.html">api</a>
                        <a class="tag-link" href="http://theodox.com/tag/articles.html">articles</a>
                        <a class="tag-link" href="http://theodox.com/tag/blog.html">blog</a>
                        <a class="tag-link" href="http://theodox.com/tag/blogging.html">blogging</a>
                        <a class="tag-link" href="http://theodox.com/tag/boo.html">boo</a>
                        <a class="tag-link" href="http://theodox.com/tag/books.html">books</a>
                        <a class="tag-link" href="http://theodox.com/tag/bugs.html">bugs</a>
                        <a class="tag-link" href="http://theodox.com/tag/careers.html">careers</a>
                        <a class="tag-link" href="http://theodox.com/tag/cg.html">cg</a>
                        <a class="tag-link" href="http://theodox.com/tag/console.html">console</a>
                        <a class="tag-link" href="http://theodox.com/tag/distribution.html">distribution</a>
                        <a class="tag-link" href="http://theodox.com/tag/games.html">games</a>
                        <a class="tag-link" href="http://theodox.com/tag/gdc.html">gdc</a>
                        <a class="tag-link" href="http://theodox.com/tag/graphics.html">graphics</a>
                        <a class="tag-link" href="http://theodox.com/tag/gui.html">GUI</a>
                        <a class="tag-link" href="http://theodox.com/tag/industry.html">industry</a>
                        <a class="tag-link" href="http://theodox.com/tag/ls.html">ls</a>
                        <a class="tag-link" href="http://theodox.com/tag/markdown.html">markdown</a>
                        <a class="tag-link" href="http://theodox.com/tag/math.html">math</a>
                        <a class="tag-link" href="http://theodox.com/tag/maya.html">maya</a>
                        <a class="tag-link" href="http://theodox.com/tag/mgui.html">mGui</a>
                        <a class="tag-link" href="http://theodox.com/tag/minq.html">minq</a>
                        <a class="tag-link" href="http://theodox.com/tag/modeling.html">modeling</a>
                        <a class="tag-link" href="http://theodox.com/tag/modelling.html">modelling</a>
                        <a class="tag-link" href="http://theodox.com/tag/modo.html">modo</a>
                        <a class="tag-link" href="http://theodox.com/tag/modules.html">modules</a>
                        <a class="tag-link" href="http://theodox.com/tag/moonrise.html">moonrise</a>
                        <a class="tag-link" href="http://theodox.com/tag/photoshop.html">photoshop</a>
                        <a class="tag-link" href="http://theodox.com/tag/pipeline.html">pipeline</a>
                        <a class="tag-link" href="http://theodox.com/tag/programming.html">programming</a>
                        <a class="tag-link" href="http://theodox.com/tag/python.html">python</a>
                        <a class="tag-link" href="http://theodox.com/tag/regex.html">regex</a>
                        <a class="tag-link" href="http://theodox.com/tag/sfx.html">sfx</a>
                        <a class="tag-link" href="http://theodox.com/tag/shaders.html">shaders</a>
                        <a class="tag-link" href="http://theodox.com/tag/siggraph.html">siggraph</a>
                        <a class="tag-link" href="http://theodox.com/tag/sod.html">SOD</a>
                        <a class="tag-link" href="http://theodox.com/tag/spelcheck.html">spelcheck</a>
                        <a class="tag-link" href="http://theodox.com/tag/standalone.html">standalone</a>
                        <a class="tag-link" href="http://theodox.com/tag/techart.html">techart</a>
                        <a class="tag-link" href="http://theodox.com/tag/thunderbirds.html">thunderbirds</a>
                        <a class="tag-link" href="http://theodox.com/tag/tools.html">tools</a>
                        <a class="tag-link" href="http://theodox.com/tag/unity.html">unity</a>
                        <a class="tag-link" href="http://theodox.com/tag/web.html">web</a>
                        <a class="tag-link" href="http://theodox.com/tag/writing.html">writing</a>
                </div>
                 <div class="vertical-spacer">
                <h4>archives</h4>
                    <a href="/archives">site history</a>
                </div> 
                <div class="vertical-spacer">
                <h4>feeds </h4>
                <p class="feed-button"><a href="/feeds/atom.xml">Atom</a></p>
                <p class="feed-button"><a href="/feeds/rss.xml">Rss</a>&nbsp;</p>
                </div>   

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

<p class="copyright text-muted">
   	Site contents &copy; Steve Theodore.  Blog powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://theodox.com/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://theodox.com/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="http://theodox.com/theme/js/clean-blog.min.js"></script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-79232212-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'theodoxcom';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>