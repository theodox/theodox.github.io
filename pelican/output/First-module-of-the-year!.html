<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="./theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="./theme/stylesheet/font-awesome.min.css">


    <link href="http://blog.theodox.com/atom/%s_all.atom.xml" type="application/atom+xml" rel="alternate" title="theodox.com Atom">



  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />

<meta name="author" content="Steve Theodore" />
<meta name="description" content="Introducing SFX -- a python module for scripting Maya shaderFX shaders." />
<meta name="keywords" content="maya, python, shaders, techart">
<meta property="og:site_name" content="theodox.com"/>
<meta property="og:title" content="First module of the year!"/>
<meta property="og:description" content="Introducing SFX -- a python module for scripting Maya shaderFX shaders."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="./First-module-of-the-year!.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-01-13 23:35:00-08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="./author/steve-theodore.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="maya"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="shaders"/>
<meta property="article:tag" content="techart"/>
<meta property="og:image" content="">
  <title>theodox.com &ndash; First module of the year!</title>
</head>
<body>
  <aside>
    <div>
      <a href=".">
        <img src="./theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href="."></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="index.html" target="_blank">home</a></li>
          <li><a href="http://python.org/" target="_blank">Python.org</a></li>
          <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
          <li><a href="#" target="_blank">You can modify those links in your config file</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/stevetheodore" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/theodox" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/u/0/+SteveTheodore480BC/posts" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1936075/theodox" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href=".">Home</a>
      <a href="TA-Bookstore-page.html">book store</a>
      <a href="http://blog.theodox.com/atom/%s_all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="First-module-of-the-year!">First module of the year!</h1>
    <p>Posted on Wed 13 January 2016 in <a href="./category/blog.html">blog</a></p>
  </header>
  <div>
    <p>It's been a busy few months at work, and the blogging has been pretty light. But I promised some folks on the Tech-Artists.org slack that I'd share some code for dealing with Mays's ShaderFX system: a very useful toolkit but not the best documented or automatable part of Maya. Since it's New Years' Resolution time, I thought I'd kill two birds with one stone and put up some notes to go with the code  </p>
<p>All of shaderfx in maya is organized by a single, undocumented command. Which is pretty lame.   </p>
<p>However, it’s not as bad as it seems once you figure out the standard command form, which is always some variant of this form:  </p>
<div class="highlight"><pre><span></span>    shaderfx -sfxnode &lt;shader node&gt; -command &lt;command&gt; &lt;node id&gt;
</pre></div>


<p>The <code>sfxnode</code> argument tells maya which sfx shader to work on. The <code>command</code> flag indiciates an action and the <code>node id</code> specifies an node in the network. Nodes are assigned an id in order of creation, with the firstnode after the root ordinarily being number 2 and so on – however the ids are not recycled so a network which has been edited extensively can have what look like random ids and there is no guarantee that the nodes will form a neat, continuous order. <br />
Many commands take additional arguments as well. Those extra always follow the main command; thus   </p>
<div class="highlight"><pre><span></span>    shaderfx -n &quot;StingrayPBS1&quot; -edit_int 19 &quot;uiorder&quot; 1;
</pre></div>


<p>sets the value of the <code>uiorder</code> field on node 19 to a value of 1. <br />
The <code>shaderfx</code> command can also return a value: to query the <code>uiorder</code> field in the example above you’d issue   </p>
<div class="highlight"><pre><span></span>    shaderfx -n &quot;StingrayPBS1&quot; -getPropertyValue 19 &quot;uiorder&quot;;  
    // Result: 1 //
</pre></div>


<p>So, the good news is that the <code>shaderfx</code> command is actually pretty capable: so far, at least, I have not found anything I really needed to do that the command did not support. For some reason the help documentation on the mel command is pretty sparse but the python version of the help text is actually quite verbose and useful.<br />
Still, it’s kind of a wonky API: a single command for everything, and no way to really reason over a network as a whole. Worse, the different types of nodes are identified only by cryptic (and undocumented) numeric codes: for example a <code>Cosine</code> node is 20205 – but the only way to find that out is to use the <code>getNodeTypeByClassName</code> command (and, by the way, the node type names are case and space sensitive).  </p>
<h2>Cleanup crew</h2>
<p>With all that baggage I was pretty discouraged about actually getting any work done using shaderfx programmatically. However a little poking around produced what I hope is a somewhat more logical API, which I’m <a href="https://github.com/theodox/sfx">sharing on github</a>.<br />
The <code>sfx</code> module is a plain python module - you can drop it into whatever location you use to story your Maya python scripts. It exposes two main classes:<br />
<strong><code>SFXNetwork</code></strong> represents a single shader network – it is a wrapper around the Maya shader ball. The <code>SFXNetwork</code> contains an indexed list of all the nodes in the network and also exposes methods for adding, deleting, finding and connecting the nodes in the network.<br />
<strong><code>SFXNode</code></strong> represets a single node inside the network. It exposes the properties of the node so they can be accessed and edited using python dot-style syntax. </p>
<p>The module also includes to submodules, <code>sfxnodes</code> and <code>pbsnodes</code>. These make it easier to work with the zillions of custom node ids: Instead of remembering that a <code>Cosine</code> node is type 20205, you reference <code>sfxnodes.Cosine</code>. I’ll be using the <code>StingrayPBSNetwork</code> class and the <code>pbsnodes</code> submodule in my examples, since most of my actual use-case involves the Stingray PBS shader. The syntax and usage, however, are the same for the vanilla <code>SFXNetwork</code> and <code>sfxnodes</code> – only the array of node types and their properties.<br />
Here’s a bit of the basic network functionality.   </p>
<h3>Create a network</h3>
<p>To create a new shaderfx network, use the <code>create()</code> classmethod:  </p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sfx</span> <span class="kn">import</span> <span class="n">StingrayPBSNetwork</span>  
<span class="kn">import</span> <span class="nn">sfx.pbsnodes</span> <span class="kn">as</span> <span class="nn">pbsnodes</span>

<span class="n">network</span> <span class="o">=</span> <span class="n">StingrayPBSNetwork</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;new_shader&#39;</span><span class="p">)</span>
</pre></div>


<p>That creates a new shaderball (note that it won’t be connected to a shadingEngine by default – that’s up to you).  </p>
<h3>Listing nodes</h3>
<p>An SFXNetwork contains a dictionary of id and nodes in the field <code>nodes</code>. This represents all of the graph nodes in the network. <em>Note I’ve used a different shader than the default one in this example to make things easier to read.</em>  </p>
<div class="highlight"><pre><span></span>print network.nodes  
# { 1 : &lt;sfxNode UnlitBase (1)&gt;, 2: &lt;sfxNode &#39;MaterialVariable&#39; (2)&gt; }

print network.nodes[2]:  
# &lt;sfxNode &#39;MaterialVariable&#39; (2)&gt;
</pre></div>


<p>The keys of the dictionary are the node ids. As already noted, these are not guaranteed to be in a continuous order depending on what you do to the network - however they are stable and they will always match the id numbers shown in the shaderfx ui when you activate the <code>show node IDs</code> toggle in the ShaderFX window.  </p>
<p>The values of the node dictionary are <code>SFXNode</code> objects.  </p>
<h3>Adding new nodes</h3>
<p>To add a node to the network use its <code>add()</code> method and pass a class from either the <code>sfxnodes</code> or <code>pbsnodes</code> submodule to indicate the type.   </p>
<div class="highlight"><pre><span></span>if_node = network.add(pbsnodes.If)  
# creates an If node and adds it to the network

var_node = network.add(pbsnodes.MaterialVariable)  
# creates a MaterialVariable node and adds it to the network
</pre></div>


<h3>Connecting nodes</h3>
<p>Connecting nodes in shaderfx requires specifying the source node the source plug, the target node and the target plug. Unforunately the plugs are indentifited by zero-based index numbers: the only way to know them by default is to count the slots in the actual shaderfx UI. Output plugs are usually (not always) going to be index zero but the target plugs can be all over the map.<br />
To make this cleaner, each <code>SFXNode</code> object exposes two fields called <code>inputs</code> and <code>outputs</code>, which have named members for the available plugs. So to connect the ‘result’ output of the <code>var_node</code> object to the input named ‘B’ on the <code>if_node</code>:  </p>
<div class="highlight"><pre><span></span>network.connect(var_node.outputs.result, if_node.inputs.b)
</pre></div>


<p>If the connection can’t be made for some reason, a <code>MayaCommandError</code> will be raised.  </p>
<p>In any shader system it's common to have to ‘swizzle’ the connections: to connect the x and z channels of a 3-pronged output to channels of an input, for example. Mismatched swizzles are a common cause of those <code>MayaCommandErrors</code>. You can set the swizzle along with the connection by passing the swizzle you need as a string  </p>
<div class="highlight"><pre><span></span>network.connect(var_node.outputs.result, if_node.inputs.b, &#39;z&#39;)  
# connects the &#39;x&#39; output of var_node  to the b channel of the input
</pre></div>


<h3>Setting node properties</h3>
<p>Nodes often have editable properties. There are a lot of different ones so it is often necessary to inspect a node and find out what properties it has and what type of values those properties accept. Every <code>SFXNode</code> object has a read-only member <code>properties</code>, which is a dictionary of names and property types. Using the same example objects as above:  </p>
<div class="highlight"><pre><span></span>print if_node.properties  
### BLah blah example here
</pre></div>


<p>If you know that a property exists on an object you can query it or set it using typical python dot syntax:  </p>
<div class="highlight"><pre><span></span>node = network.properties[5]   
# get the node at index 5 in this network

print node.properties:  
# { &#39;min&#39;: &#39;float&#39;, &#39;max&#39;: &#39;float&#39;, &#39;method&#39;: &#39;stringlist&#39; }

print node.min  
# 1.0  
# getting a named property returns its value.

node.min = 2.0  
# sets the node value

print node.min  
# 2.0
</pre></div>


<p>If you try to access a property that doesnt exist, an error will be raised:  </p>
<div class="highlight"><pre><span></span>print node.i_dont_exist  
# AttributeError: no attribute named i_dont_exist

node.i_dont_exist = 99  
# MayaCommandError
</pre></div>


<h2>Help wanted!</h2>
<p>So, there’s the basics. This module is pretty simple but I’ve found it <em>extremely</em> helpful in workign with SFX nodes. It will be much easier to work with, of course, if you already know your way around ShaderFX. Please let me know how it works for you – and as always bug reports and pull requests are very welcome! </p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/maya.html">maya</a>
      <a href="./tag/python.html">python</a>
      <a href="./tag/shaders.html">shaders</a>
      <a href="./tag/techart.html">techart</a>
    </p>
  </div>
</article>

    <footer>
        <p>&copy; Steve Theodore 2016</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "First module of the year!",
  "headline": "First module of the year!",
  "datePublished": "2016-01-13 23:35:00-08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Steve Theodore",
    "url": "./author/steve-theodore.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "./First-module-of-the-year!.html",
  "description": "Introducing SFX -- a python module for scripting Maya shaderFX shaders."
}
</script></body>
</html>