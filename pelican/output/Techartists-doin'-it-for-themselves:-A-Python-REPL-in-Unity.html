<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="./theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="./theme/stylesheet/font-awesome.min.css">


    <link href="http://blog.theodox.com/atom/%s_all.atom.xml" type="application/atom+xml" rel="alternate" title="theodox.com Atom">



  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

<meta name="author" content="Steve Theodore" />
<meta name="description" content="pending" />
<meta name="keywords" content="">
<meta property="og:site_name" content="theodox.com"/>
<meta property="og:title" content="Techartists doin' it for themselves: A Python REPL in Unity"/>
<meta property="og:description" content="pending"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="./Techartists-doin'-it-for-themselves:-A-Python-REPL-in-Unity.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2013-12-22 10:10:00.003000-08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="./author/steve-theodore.html">
<meta property="article:section" content="blog"/>
<meta property="og:image" content="">
  <title>theodox.com &ndash; Techartists doin' it for themselves: A Python REPL in Unity</title>
</head>
<body>
  <aside>
    <div>
      <a href=".">
        <img src="./theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href="."></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="index.html" target="_blank">home</a></li>
          <li><a href="http://python.org/" target="_blank">Python.org</a></li>
          <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
          <li><a href="#" target="_blank">You can modify those links in your config file</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/stevetheodore" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/theodox" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/u/0/+SteveTheodore480BC/posts" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1936075/theodox" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="Techartists-doin'-it-for-themselves:-A-Python-REPL-in-Unity">Techartists doin' it for themselves: A Python REPL in Unity</h1>
    <p>Posted on Sun 22 December 2013 in <a href="./category/blog.html">blog</a></p>
  </header>
  <div>
    <p>Last time, I sketched out the basics of <a href="http://techartsurvival.blogspot.com/2013/12/embedding-ironpython-in-unity-tech-art.html">embedding a Python intepreter into Unity.</a>   That's cool emough -- but unless you're so desperate for Python that you're willing to script your whole application inside of triple quotes it doesn't have a ton of immediate applications.  </p>
<p>So, this time out I'll sketch out how to build a simple script editor inside of Unity (at the risk of repeating myself, I'll just say again that the extensibility of the Unity editor is an incredible aid to game developers of all stripes, and to tech artists in particular -- it's pretty amazing you can hack in something this complex without source code access or esoteric C++ chops.  </p>
<h2>Prologomena</h2>
<p>The basic strategy for this excersize is simply to create a Unity window with two panes - a 'history' pane  and a  'script' pane -- and before you ask, yes, it's just a ripoff of the Maya listener.   </p>
<p>Before setting up the GUI, we need to cover the framework - the code that will keep the GUI stat and also set up the Python intepreter. In this example, you'll see a bunch of properties declared for the use of the GUI - notably __historyText_ and __scriptText_, which hold the actual contents of the listener and the history pane.  The other notable feature is the same duo of __ScriptEngine, <em>and __ScriptScope</em> which we went over in the <a href="http://techartsurvival.blogspot.com/2013/12/embedding-ironpython-in-unity-tech-art.html">last post</a>_. _If those terms don't mean anything to you you might want to follow that link before proceeding).  </p>
<div class="highlight"><pre><span></span> using UnityEngine;    
 using UnityEditor;    
 using IronPython;    
 using IronPython.Modules;    
 using System.Text;    
 using System.Collections.Generic;    
 using Microsoft.Scripting.Hosting;    
 // derive from EditorWindow for convenience, but this is just a fire-n-forget script    
 public class ScriptExample : EditorWindow    
 {    
     // class member properties  
     Vector2 _historyScroll;    
     Vector2 _scriptScroll;    
     bool _showHistory = true;    
     int _historyPaneHeight = 192;    
     string _historyText = &quot;history&quot;;    
     string _scriptText = &quot;script&quot;;    
     string _lastResult = &quot;&quot;;    
     TextEditor _TEditor;    
     GUIStyle consoleStyle = new GUIStyle ();    
     GUIStyle historyStyle = new GUIStyle ();    
     Microsoft.Scripting.Hosting.ScriptEngine _ScriptEngine;    
     Microsoft.Scripting.Hosting.ScriptScope _ScriptScope;

     // initialization logic (it&#39;s Unity, so we don&#39;t do this in the constructor!  
     public void OnEnable ()    
     {       
         // pure gui stuff  
         consoleStyle.normal.textColor = Color.yellow;    
         consoleStyle.margin = new RectOffset (20, 10, 10, 10);    
         historyStyle.normal.textColor = Color.white;    
         historyStyle.margin = new RectOffset (20, 10, 10, 10);

         // load up the hosting environment    
         _ScriptEngine = IronPython.Hosting.Python.CreateEngine ();    
         _ScriptScope = _ScriptEngine.CreateScope ();

         // load the assemblies for unity, using types    
         // to resolve assemblies so we don&#39;t need to hard code paths    
         _ScriptEngine.Runtime.LoadAssembly (typeof(PythonFileIOModule).Assembly);    
         _ScriptEngine.Runtime.LoadAssembly (typeof(GameObject).Assembly);    
         _ScriptEngine.Runtime.LoadAssembly (typeof(Editor).Assembly);    
         string dllpath = System.IO.Path.GetDirectoryName (    
             (typeof(ScriptEngine)).Assembly.Location).Replace (    
             &quot;\\&quot;, &quot;/&quot;);    
         // load needed modules and paths    
         StringBuilder init = new StringBuilder ();    
         init.AppendLine (&quot;import sys&quot;);    
         init.AppendFormat (&quot;sys.path.append(\&quot;{0}\&quot;)\n&quot;, dllpath + &quot;/Lib&quot;);    
         init.AppendFormat (&quot;sys.path.append(\&quot;{0}\&quot;)\n&quot;, dllpath + &quot;/DLLs&quot;);    
         init.AppendLine (&quot;import UnityEngine as unity&quot;);    
         init.AppendLine (&quot;import UnityEditor as editor&quot;);    
         init.AppendLine (&quot;import StringIO&quot;);    
         init.AppendLine (&quot;unity.Debug.Log(\&quot;Python console initialized\&quot;)&quot;);    
         init.AppendLine (&quot;__print_buffer = sys.stdout = StringIO.StringIO()&quot;);    
         var ScriptSource = _ScriptEngine.CreateScriptSourceFromString (init.ToString ());    
         ScriptSource.Execute (_ScriptScope);    
     }

    public  void OnGUI (){} // see next code snippet  
 }
</pre></div>


<p>As in the last example you'll also not that we're manually setting up sys.path to point at the directory where IronPython is installed, with a little extra code to make it portable  (dotNet assemblies can tell you where they live on disk, so it's a cheap shortcut to find your install directory).   </p>
<p>The only thing in here that is really 'architecturally' important its this line:  </p>
<div class="highlight"><pre><span></span>         init.AppendLine (&quot;__print_buffer = sys.stdout = StringIO.StringIO()&quot;);
</pre></div>


<p>What's going on there is that we're replacing sys.stdout - which in ordinary Python points at the user's console - with a <a href="http://docs.python.org/2/library/stringio.html">StringIO </a>object.  StringIO mimicks a file -- and so does sys.stdout. By stuffing __print_buffer in there we are hijacking any calls to print that you might make in a script so we can print them out in our UI.  This is trick should be familiar to tech artists who need <a href="http://www.drakeguan.org/blog/2009/02/How-to-make-Maya-output-all-messages-into-console-terminal/">to grab the Maya console for nefarious purposes.</a>  </p>
<h2>Unity GUI - the ~~good, ~~the bad, and the ugly</h2>
<p>Unity's GUI toolkit is notoriously wonky, and you'll see as we go along that much of the energy here is devoted to working around it's limitations.  While we can go pretty far just using the basics, the is a certain <a href="http://users_v2.section101.com/memberdata/ru/rubegoldberg/photos/rubegoldberg_photo_gal_4155_photo_1695691461_lr.jpg">Rube Goldberg</a> quality to what follows. You've been warned.  </p>
<p>First let's just layout out the actual drawing call - the OnGUI method of our window:  </p>
<div class="highlight"><pre><span></span> using UnityEngine;    
 using UnityEditor;    
 using IronPython;    
 using IronPython.Modules;    
 using System.Text;    
 using System.Collections.Generic;    
 using Microsoft.Scripting.Hosting;    
 // derive from EditorWindow for convenience, but this is just a fire-n-forget script    
 public class ScriptExample : EditorWindow    
 {    
    /* snip... see previous example for the setup code... */

     public void OnGUI ()    
     {    
         HackyTabSubstitute ();  // this is explained below...

         // top pane with history    
         _showHistory = EditorGUILayout.Foldout (_showHistory, &quot;History&quot;);    
         if (_showHistory) {    
             EditorGUILayout.BeginVertical (GUILayout.ExpandWidth (true),     
             GUILayout.Height (_historyPaneHeight));    
             if (GUILayout.Button (&quot;Clear history&quot;)) {    
                 _historyText = &quot;&quot;;    
             }    
             _historyScroll = EditorGUILayout.BeginScrollView (_historyScroll);    
             EditorGUILayout.TextArea (_historyText,     
                 historyStyle,     
                 GUILayout.ExpandWidth (true),     
                 GUILayout.ExpandHeight (true));            
             EditorGUILayout.EndScrollView ();    
             EditorGUILayout.EndVertical ();    
         }    
         // draggable splitter    
         GUILayout.Box (&quot;&quot;, GUILayout.Height (8), GUILayout.ExpandWidth (true));    
         //Lower pane for script editing    
         EditorGUILayout.BeginVertical (GUILayout.ExpandWidth (true),     
             GUILayout.ExpandHeight (true));    
         _scriptScroll = EditorGUILayout.BeginScrollView (_scriptScroll);    
         GUI.SetNextControlName (&quot;script_pane&quot;);    
         // note use of GUILayout NOT EditorGUILayout.    
         // TextEditor is not accessible for EditorGUILayout!    
         _scriptText = GUILayout.TextArea (_scriptText,     
             consoleStyle,    
             GUILayout.ExpandWidth (true),     
             GUILayout.ExpandHeight (true));            
         _TEditor = (TextEditor)GUIUtility.GetStateObject (typeof(TextEditor), GUIUtility.keyboardControl);    
         EditorGUILayout.EndScrollView ();    
         EditorGUILayout.BeginHorizontal ();    
         if (GUILayout.Button(&quot;Clear&quot;, GUILayout.ExpandWidth(true)))    
         {    
             _scriptText = &quot;&quot;;    
             GUI.FocusControl(&quot;script_pane&quot;);    
         }    
         if (GUILayout.Button (&quot;Execute and clear&quot;, GUILayout.ExpandWidth (true))) {    
             Intepret (_scriptText);    
             _scriptText = &quot;&quot;;    
             GUI.FocusControl(&quot;script_pane&quot;);    
         }    
         if (GUILayout.Button (&quot;Execute&quot;, GUILayout.ExpandWidth (true))) {    
             Intepret (_scriptText);    
         }    
         EditorGUILayout.EndHorizontal ();    
         EditorGUILayout.EndVertical ();        
         // mimic maya Ctrl+enter = execute    
         if (Event.current.isKey &amp;&amp;    
             Event.current.keyCode == KeyCode.Return &amp;&amp;    
             Event.current.type == EventType.KeyUp &amp;&amp;    
             Event.current.control) {    
             Intepret (_scriptText);    
         }    
         // drag the splitter    
         if (Event.current.isMouse &amp; Event.current.type == EventType.mouseDrag)    
         {_historyPaneHeight = (int) Event.current.mousePosition.y - 28;    
             Repaint();    
         }    
     }

 }
</pre></div>


<p>If you're familiar with the dark arts of Unity GUI programming this should be pretty straight forward. If you're not, the key to understanding it is to remember that Unity uses what old-schooler's call <em><a href="http://lambda-the-ultimate.org/node/4561">Immediate mode GUI</a></em> , in which each control gets evaluated as it is declared .  There's a <a href="http://mollyrocket.com/forums/viewtopic.php?t=134">case to be made </a>that immediate mode is better for performance sensitive applications, but if you're used to the more typical (aka 'retained') mode GUIs in, for example, QT it's kind of an oddball way to write.   </p>
<p>As each GUI element is drawn it reflects and then possibly updates the data that it relies on -- so, for example, we pass the string __scriptText _ to the GUI.TextArea that draws the script listener pane - and the results of any changes are immediately passed back into __scriptText_ without the courtesy of a callback. This makes it tricky to manage complex state - as you run down the GUI draw, it's possible to hit a condition which changes a state and sends you back to the start! This makes it important to keep your state management code very clean and simple.  </p>
<p>The one bit that may surprise people who do have some Unity experience its the line  </p>
<div class="highlight"><pre><span></span>_TEditor = (TextEditor)GUIUtility.GetStateObject (typeof(TextEditor),   
                                                  GUIUtility.keyboardControl);
</pre></div>


<p>The <em>TextEditor</em> class is an undocumented bit of Unity arcana - it is a wrapper on the code that actually handles things like typing, selecting or cutting and pasting into a Unity text field.  It has methods for things like setting the cursor location and executing copy-paste operations. Unfortunately, being undocumented, it's tricky to figure out what to do with it -- in this example I'm only using it to preserve the selection position when I do something crazy - as you'll see in a moment.  </p>
<h2>Hacktastic</h2>
<p>You probably noticed the enigmatic line  </p>
<p>HackyTabSubstitute()    </p>
<p>which leads up to the tricky bit of this example  -- and the reason for my earlier hack disclaimer.  </p>
<p>Tabs of course are the _<a href="http://www.wisegeek.com/what-is-sine-qua-non.htm#didyouknowout">sine qua non</a> _for Pythonistas.  Unfortunately Unity catches the tab key before you can grab it, so it's impossible to 'type' a tab into a Unity text field.  After banging my head against this for a while, I settled on a pathetic workaround: _just cheat and use the tilde key, _which is above the tab key on most keyboards and doesn't have semantic importance in Python. Our new friend HackyTabSubsitute() makes sure that each time the GUI is drawn we replace and  backtick characters with indents and any tildes (shift-backtick) with dedents.  You can see how we also preserve the cursor position  by use of the _TextEditor.  </p>
<div class="highlight"><pre><span></span>         / // use ` and ~ as substitutes for tab and un-tab
</pre></div>


<p>private void HackyTabSubstitute () { string _t = _scriptText; string[] lines = _scriptText.Split ('\n'); for (int i = 0; i&lt; lines.Length; i++) { if (lines [i].IndexOf ('<code>') &amp;gt;= 0) { lines [i] = " " + lines [i]; _TEditor.selectPos = _TEditor.pos = _TEditor.pos + 3; } if (lines [i].IndexOf (" ") &amp;gt;= 0 &amp;amp;&amp;amp; lines [i].IndexOf ("~") &amp;gt;= 0) { if (lines [i].StartsWith (" ")) lines [i] = lines [i].Substring (4); _TEditor.selectPos = _TEditor.pos = _TEditor.pos - 4; } lines [i] = lines [i].Replace ("~", ""); lines [i] = lines [i].Replace ("</code>", ""); } _scriptText = string.Join ("\n", lines); if (_scriptText != _t) Repaint (); } `</p>
<p><code></code></p>
<p>Assuming you can discipline yourself to use tilde instead of tab, this works like you'd expect, and it supports indents and dedents in any part of the line, which is handy for python edits.  </p>
<h2>Running the script</h2>
<p>As so often happens, it's the damn GUI which takes all the work. The actual point of this whole excersize is to let you type in some python and execute it. If you trigger an evaluation - with the buttons or with command + enter, you'll fire the Interpret function:  </p>
<div class="highlight"><pre><span></span>     // Pass the script text to the interpreter and display results    
     private void Intepret (string text_to_interpret)    
     {    
         object result = null;    
         try {    
             Undo.RegisterSceneUndo (&quot;script&quot;);    
             var scriptSrc = _ScriptEngine.CreateScriptSourceFromString (text_to_interpret);    
             _historyText += &quot;\n&quot;;    
             _historyText += text_to_interpret;    
             _historyText += &quot;\n&quot;;    
             result = scriptSrc.Execute (_ScriptScope);    
         }     
         // Log exceptions to the console too    
         catch (System.Exception e) {    
             Debug.LogException (e);    
             _historyText += &quot;\n&quot;;    
             _historyText += &quot;#  &quot; + e.Message + &quot;\n&quot;;    
         }     
         finally {    
             // grab the __print_buffer stringIO and get its contents    
             var print_buffer = _ScriptScope.GetVariable (&quot;__print_buffer&quot;);    
             var gv = _ScriptEngine.Operations.GetMember (print_buffer, &quot;getvalue&quot;);    
             var st = _ScriptEngine.Operations.Invoke (gv);    
             var src = _ScriptEngine.CreateScriptSourceFromString (&quot;__print_buffer = sys.stdout = StringIO.StringIO()&quot;);    
             src.Execute (_ScriptScope);    
             if (st.ToString ().Length &gt; 0) {    
                 _historyText += &quot;&quot;;    
                 foreach (string l in st.ToString().Split(&#39;\n&#39;))    
                 {    
                     _historyText += &quot;  &quot; + l + &quot;\n&quot;;    
                 }    
                 _historyText += &quot;\n&quot;;    
             }    
             // and print the last value for single-statement evals    
             if (result != null) {    
                 _historyText += &quot;#  **&quot; + result.ToString () + &quot;**\n&quot;;    
             }    
             int lines = _historyText.Split (&#39;\n&#39;).Length;    
             _historyScroll.y += (lines * 19);                    
             Repaint ();    
         }    
     }    
 }
</pre></div>


<p>The heart of the whole business is just  </p>
<div class="highlight"><pre><span></span>result = scriptSrc.Execute (_ScriptScope);
</pre></div>


<p>which actually executes the contents of your script window.  As in Maya, we'll copy the evaluated text up to the history pane  (<em>historyText += ,etc).  If the event of an exception, we print out the exception into the history window as well, and also push a Unity debug message in case you aren't looking at your console window when the problem arises.  Finally, we check to see if the ___print_buffer</em> StringIO object has been written to duing the script execution  and copy it's contents to the history window too.   </p>
<p><a href="http://1.bp.blogspot.com/-DRvP1YjaeZg/UrcrG6xumEI/AAAAAAAABP0/XwuthQ55-iA/s1600/example.png"><img alt="" src="http://1.bp.blogspot.com/-DRvP1YjaeZg/UrcrG6xumEI/AAAAAAAABP0/XwuthQ55-iA/s1600/example.png" /></a></p>
<h2></h2>
<h2>v. 0.1</h2>
<p>Before starting the first of this pair of posts I was mostly just musing on how TA-friendly Unity is.   Building out a complete script editor is a perfect example of TA feature creep in action.  </p>
<p>If you implement a script editor using the hints here you'll quickly see what's not there things like cut and paste, syntax highlighting, execution of selected text only and support for external files, just to name a few things that would be worth having.  And I should mention that this is demo code, it's not the sort of thing I'd want to turn into a critical path tool without further work.   </p>
<p>Even so, it's been a useful little project.  In this holiday season it's taught me to appreciate my blessings - like how many nice little touches you get with a modern text editor. I'm even feeling more charitable towards the Max and Maya script listeners, since I've walked a mile in their sad patheric old worn out shoes.   </p>
<p>All that said though, it really is <em>pretty fricking neat</em> that you can add a completely new scripting language to the Unity editor in a couple of hours -- and save your self tons of future time by adding cheapo scripts to automate tedious tasks that aren't worth 200 lines of C# curly brackets.  </p>
<p>At some point I'll address the most obvious failings - lack of cut-n-paste is the clear winner! - but first I want to see about implementing the console in a more flexible GUI - for example, I could pop up a WPF window, or maybe even something truly funky like an <a href="http://techartsurvival.blogspot.com/2013/12/python-in-browsers.html">in-browser python console.</a>.  In the mean time, if anybody takes this further I'd love to hear about it.  </p>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
</article>

    <footer>
        <p>&copy; Steve Theodore </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Techartists doin' it for themselves: A Python REPL in Unity",
  "headline": "Techartists doin' it for themselves: A Python REPL in Unity",
  "datePublished": "2013-12-22 10:10:00.003000-08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Steve Theodore",
    "url": "./author/steve-theodore.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "./Techartists-doin'-it-for-themselves:-A-Python-REPL-in-Unity.html",
  "description": "pending"
}
</script></body>
</html>