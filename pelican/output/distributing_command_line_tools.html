<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>distributing_command_line_tools</title>
        <link rel="stylesheet" href="./theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">static_site_test </a></h1>
                <nav><ul>
                    <li class="active"><a href="./category/blog.html">Blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./distributing_command_line_tools.html" rel="bookmark"
           title="Permalink to distributing_command_line_tools">distributing_command_line_tools</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-01-01T00:00:00-08:00">
                Published: Thu 01 January 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/stevet.html">stevet</a>
        </address>
<p>In <a href="./category/blog.html">Blog</a>.</p>
<p>tags: <a href="./tag/blog.html">blog</a> </p>
</footer><!-- /.post-info -->      <p>It's pretty common for TA's to want some specialty command-line tools that for their own use, or to share with a select number of power users who aren't afraid of typing.  While python is great at making tools for this kind of one-off use, distributing and maintaing these kinds of scripts  requires jumping even more hoops than sending out artist tools (something covered in more detail <a href="http://techartsurvival.blogspot.com/2014/06/save-environment.html">here</a> and <a href="http://techartsurvival.blogspot.com/2014/07/save-environment-2-i-am-egg-man.html">here</a>). </p>
<p>It's much easier for folders full of loose scripts to diverge among coders, who are likely to be tinkering with their contents, than it is among artists.  My usual answer to keeping the artists on the same page is to <a href="http://techartsurvival.blogspot.com/2014/07/save-environment-2-i-am-egg-man.html">distribute a complete environment in a single .zip file</a>, which has definitely cut my distribution headaches by an order of magnitude and simplified my management a great deal.</p>
<p>Lately one of my colleagues has been working on some command line tools and we realized that we can get many of the same benefits by using the same zip file as part of our command line arsenal.  This means we can write scipts that use our up-to-date in-house libraries (and also all of the path manipulation that gets done for our artist tools) without modification.</p>
<h1>HED</h1>
<p>The trick is really pretty simple. All you need to do is include a <code>__main__.py</code> in the zip file.  Any python zip with a <code>__main__.py</code> is treated by python as an executable script.  Here's a trivial example:</p>
<div class="highlight"><pre><span></span><span class="c1"># main.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">print</span> <span class="s2">&quot;# I was called with&quot;</span><span class="p">,</span> <span class="n">arguments</span>
</pre></div>


<p>If you zip that file, you can execute it like so:</p>
<div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">zip</span> <span class="n">hello</span> <span class="n">world</span>
<span class="c1"># I was called with hello world</span>
</pre></div>


<p>Once you understand that, you can build a flexible command-line toolkit that uses your library quite simply.  You'll need to collect all of your path mongering into a single place, but that's a good idea in any case -- things get crazy pretty quick if every module can mess with <code>sys.path</code> on a whim.  I use a module that mimics <code>site</code> but works for zips as well as loose files:</p>
<div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">zipsite</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">SiteProcessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pth_files</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_pth_file</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pth_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this gets overridden in derived classes</span>
        <span class="c1"># so that zips and loose files worh the same</span>
        <span class="k">yield</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_pth_file</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;import&quot;</span><span class="p">):</span>
                <span class="k">exec</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">continue</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="s2">&quot;{0}/{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_path</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FolderSiteProcessor</span><span class="p">(</span><span class="n">SiteProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">pth_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">roots</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pth&quot;</span><span class="p">):</span>
                    <span class="n">clean_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">roots</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">clean_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">roots</span><span class="p">,</span> <span class="n">handle</span>


<span class="k">class</span> <span class="nc">ZipSiteProcessor</span><span class="p">(</span><span class="n">SiteProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">pth_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">all_names</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
        <span class="n">all_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">pth_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">all_names</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pth&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">pthfile</span> <span class="ow">in</span> <span class="n">pth_list</span><span class="p">:</span>
            <span class="n">local_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">pthfile</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pthfile</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">local_pth</span><span class="p">,</span> <span class="n">contents</span>


<span class="k">def</span> <span class="nf">addsitedir</span><span class="p">(</span><span class="o">*</span><span class="n">roots</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for every .pth file in or under each root, process the pth file</span>
<span class="sd">    in the same way as site.addsitedir()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">each_root</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">each_root</span><span class="p">):</span>
            <span class="n">ZipSiteProcessor</span><span class="p">(</span><span class="n">each_root</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FolderSiteProcessor</span><span class="p">(</span><span class="n">each_root</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>


<p>As long as that's in my distribution zip, my <code>__main__</code> cam setup all the paths with a couple of lines:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">zipsite</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">zipsite</span><span class="o">.</span><span class="n">addsitedir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">__file__</span> <span class="o">+</span> <span class="s2">&quot;/..&quot;</span><span class="p">))</span>
</pre></div>


<p>All the real work is delegated to the .pth files, which is a much simpler and less error prone method than letting the individual modules run rampant.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>