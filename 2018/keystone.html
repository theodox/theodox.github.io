
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet/less" type="text/css" href="https://theodox.github.io/theme/stylesheet/style.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>

  <link rel="stylesheet" type="text/css" href="https://theodox.github.io/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://theodox.github.io/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://theodox.github.io/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Chimeras & Manticores Atom">

    <link href="https://theodox.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Chimeras & Manticores RSS">


<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79232212-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Steve Theodore" />
<meta name="description" content="An even funkier method to launch Maya Python from the desktop, with a little help from our old friend MEL." />
<meta name="keywords" content="python, maya, programming, distribution, MEL, techart">

<meta property="og:site_name" content="Chimeras & Manticores"/>
<meta property="og:title" content="Keystone"/>
<meta property="og:description" content="An even funkier method to launch Maya Python from the desktop, with a little help from our old friend MEL."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://theodox.github.io/2018/keystone"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-11-25 00:00:00-08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://theodox.github.io/author/steve-theodore.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="maya"/>
<meta property="article:tag" content="programming"/>
<meta property="article:tag" content="distribution"/>
<meta property="article:tag" content="MEL"/>
<meta property="article:tag" content="techart"/>
<meta property="og:image" content="">

   <title>Chimeras & Manticores &ndash; Keystone</title>


    <link rel="canonical" href="https://theodox.github.io/2018/keystone"/>

  <script type="text/javascript">
    var host = "https://theodox.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
      window.location.protocol = "https";
  </script>

</head>
<body>



  <aside>
    <div>
      <h2>Chimeras & Manticores</h2>
      <a href="https://theodox.github.io">
        <img src="https://theodox.github.io/theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href="https://theodox.github.io"></a></h1>

<p>a blog about technical art, python, the games business, and obscurantism</p>


      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/stevetheodore" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/theodox" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/u/0/+SteveTheodore480BC/posts" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/1936075/theodox" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
      </ul>

    <nav>
<!---if pages or LINKS -->


        <div>
          <h3 class="tagcloud_header">SUBJECTS</h3>
        </div>
        <ul class="tagcloud">
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/mel.html">
                MEL
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/animation.html">
                animation
                        <span class="badge">(3)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/api.html">
                api
                        <span class="badge">(3)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/articles.html">
                articles
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/blog.html">
                blog
                        <span class="badge">(3)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/blogging.html">
                blogging
                        <span class="badge">(4)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/boo.html">
                boo
                        <span class="badge">(3)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/books.html">
                books
                        <span class="badge">(4)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/bugs.html">
                bugs
                        <span class="badge">(5)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/cg.html">
                cg
                        <span class="badge">(8)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/distribution.html">
                distribution
                        <span class="badge">(5)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/games.html">
                games
                        <span class="badge">(10)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/gdc.html">
                gdc
                        <span class="badge">(12)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/graphics.html">
                graphics
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/gui.html">
                gui
                        <span class="badge">(7)</span>
                </a>
            </li>
            <li class="tag-1">
                <a href="https://theodox.github.io/tag/industry.html">
                industry
                        <span class="badge">(34)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/jobs.html">
                jobs
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/markdown.html">
                markdown
                        <span class="badge">(3)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/math.html">
                math
                        <span class="badge">(5)</span>
                </a>
            </li>
            <li class="tag-1">
                <a href="https://theodox.github.io/tag/maya.html">
                maya
                        <span class="badge">(48)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/mgui.html">
                mgui
                        <span class="badge">(10)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/minq.html">
                minq
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/modeling.html">
                modeling
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/modules.html">
                modules
                        <span class="badge">(3)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/moonrise.html">
                moonrise
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/pipeline.html">
                pipeline
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-1">
                <a href="https://theodox.github.io/tag/programming.html">
                programming
                        <span class="badge">(40)</span>
                </a>
            </li>
            <li class="tag-1">
                <a href="https://theodox.github.io/tag/python.html">
                python
                        <span class="badge">(50)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/rigging.html">
                rigging
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-3">
                <a href="https://theodox.github.io/tag/sfx.html">
                sfx
                        <span class="badge">(2)</span>
                </a>
            </li>
            <li class="tag-1">
                <a href="https://theodox.github.io/tag/techart.html">
                techart
                        <span class="badge">(22)</span>
                </a>
            </li>
            <li class="tag-1">
                <a href="https://theodox.github.io/tag/tools.html">
                tools
                        <span class="badge">(16)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/unity.html">
                unity
                        <span class="badge">(4)</span>
                </a>
            </li>
            <li class="tag-2">
                <a href="https://theodox.github.io/tag/web.html">
                web
                        <span class="badge">(6)</span>
                </a>
            </li>
      </ul>
      </nav>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://theodox.github.io">    Home
</a>

      <a href="/about">About...</a>
      <a href="/pages/pub">Publications</a>
      <a href="/pages/cookbook">Cookbook</a>
      <a href="/archives">By date</a>
      <a href="/tags">By subject</a>

      <a href="https://theodox.github.io/feeds/atom.xml">    Atom
</a>

      <a href="https://theodox.github.io/feeds/rss.xml">    RSS
</a>
    </nav>

<article class="single">
  <header>
      
    <h1 id="keystone">Keystone</h1>
    <p>
          Posted on Sun 25 November 2018 in <a href="https://theodox.github.io/category/blog.html">blog</a>


    </p>
  </header>


  <div>
    <p><a href="/2018/pythonception">Last time out</a>, we talked about how to &#8216;compile&#8217; a python script into a form that could be stuffed inside a <span class="caps">MEL</span> file &#8212; and, therefore, could be launched directly from your desktop without the need for a <span class="caps">BAT</span> file, launcher app, or long cumbersome command line.  I ended up by hinting that there was more to come on the same&nbsp;idea.  </p>
<p>The strategy we sketched out for the first version worked by converting a single file to a base64-encoded binary representation that could be safely stored in a <span class="caps">MEL</span> string variable without complicated escaping of special characters and so on.  That&#8217;s a great trick &#8212; as long as what you&#8217;re trying to accomplish can be done in a single&nbsp;file.</p>
<p>However, a single script is usually just a tiny part of a real-world production pipeline.  Real Maya environments are usually much more sprawling &#8212; at my work ours is fairly modest and it&#8217;s still several hundred files and tens of thousands of lines of code.  There are dozens of modules and libraries involved. Jamming all of that into a single string and executing it would be, well&#8230; let&#8217;s just call it&nbsp;&#8220;ambitious.&#8221;</p>
<h2>Sprawl</h2>
<p>How to maintain and version a big sprawling environment like that is a <a href="http://tech-artists.org/t/maya-github-and-script-paths-for-mel-and-python-how-would-you-do-it/3718/21">frequent subject for discussion</a> going back <a href="http://discourse.techart.online/t/python-maya-startup-script/2145">many years</a>.  All of the different strategies, however, amount to roughtly the same basic&nbsp;ideas:</p>
<ol>
<li>Make sure that everything you depend on is available to all your users in the same way &#8212; there&#8217;s no worse kind of bug-hunting than the dreaded <strong>&#8220;It worked on my machine&#8230;!&#8221;</strong>&nbsp;variety. </li>
<li>Getting the right bits to your users also means  making sure they don&#8217;t have the wrong ones.  An out of date library or a leftover .pyc file can be even worse than a missing file, since incorrect code can create subtler and more difficult to catch&nbsp;problems.</li>
<li>You&#8217;ll probably have to support multiple configurations, so make it easy to pick a toolkit at startup time instead of just pointing at one file&nbsp;location. </li>
</ol>
<p>What I&#8217;ve <a href="https://theodox.github.io/2014/egg_man">been doing for many years</a> is to maintain my entire environment as a single zip file. Since Python allows you to put zip files on your Python path and will find modules inside zips automatically this doesn&#8217;t require any special code &#8212; yet it does ensure that there is one and only one copy of the toolkit running in any given scenario. We use a launcher app that puts the zip on the Python path and tells Maya to run it at startup, so you can always run a different toolkit by simply bypassing the launcher, or by using a different launch script that points at a different zip&nbsp;file. </p>
<p>This zip-based system has worked like a charm for the better part of a decade, and I&#8217;ve never regretted adopting it.  The only thing that has always frustrated me about it is the fact that you still need to find a way to tell Maya about that zip file.  <code>userSetup.py</code> works fine for this, but many users want that userSetup for their own customization purposes and you don&#8217;t want people to have to hand edit that file to switch between projects.  Custom launcher scripts (<span class="caps">BAT</span> files or other ways of formatting a command line argument to Maya) support project switching well &#8212; but they are separate software projects int their own right with their own distribution and versioning hassles.  Plus, they add an extra support burden when you&#8217;re supporting people at remote studios who don&#8217;t necessarily participate in your entire studio&nbsp;ecosystem.</p>
<p>A distribution method that was simple and robust and untethered to external depenendencies has been a kind of obsession of mine for a long time now.  Thanks to the Python-inside-<span class="caps">MEL</span> idea from our last outing, I think it&#8217;s finally within&nbsp;reach. </p>
<h2>Keystone&#8230;</h2>
<p>I&#8217;ve got a working first version of the concept bundled up into a short, single-file script that <a href="https://github.com/theodox/keystone">you can get from this GitHub</a> &#8212; a project I&#8217;ve dubbed <code>Keystone</code> because, ya know, lame &#8220;pipelne&#8221;&nbsp;puns.</p>
<p>Keystone is a simple command line script that you point at a folder which contains your Python toolkit.  It will compile all of the Python files to <code>.pyc</code> for speed and then zip them up into a single archive.  Then, it will generate a startup script to find an launch the zipped-up toolkit.  Finally it will compile that startup script and the binary data from the zip file into a double-clickable <span class="caps">MEL</span> file &#8212; a single-source distribution of the whole shebang which doesn&#8217;t need any extra&nbsp;infrastructure.</p>
<p>The strategy is actually very simple. Just as the last post showed how to stuff Python code into a binary blob inside the <span class="caps">MEL</span> file, Keystone does the same thing for a zipped-up Python tookit.  The final result is a <span class="caps">MEL</span> file which makes sure the user has a zipped up copy of the Python environment, puts that zip on the user&#8217;s path, and launches it inside of Maya when the user double-clicks on the <span class="caps">MEL</span>.  This combines all the ease-of-use advantages of having a <span class="caps">MEL</span> launcher instead of a separately maintained <span class="caps">BAT</span> file or a complex command line with the ability to distribute a big, complex toolset in a single bundle.  The self-contained nature of the <span class="caps">MEL</span>-zip hybride makes it trivially easy to maintain multiple versions side-by-side.  The launcher <em>is</em> the environment and&nbsp;vice-versa.</p>
<h2>..the&nbsp;pipeline</h2>
<p>Here&#8217;s a basic flowchart of what happens in a Keystone pipeline ( environmental destruction, petro-dollars, and giant protest puppets omitted for&nbsp;clarity):</p>
<p><img alt="" src="/images/keystone-pipeline.svg"></p>
<p>The only &#8216;complexity&#8217; &#8212; it barely deserves the name &#8212; is the way in which the zip file data is jammed into the <span class="caps">MEL</span> file.  This amounts to simply generating a zip file, reading it in as binary bytes, and appended those bytes to the end of the <span class="caps">MEL</span> file after a comment mark so that Maya doesn&#8217;t try to read them.  The offset where the comment begins is encoded into the script so that it&#8217;s eay to grab the relevant bits and put them back on the user&#8217;s hard drive as ordinary zip&nbsp;files. </p>
<p>The Keystone compiler automatically generates the code to add the zip file onto the Python path (this script is encoded using the base64 method we outlined in the <a href="2018/pythonception">previous post</a>). When the user runs the <span class="caps">MEL</span> file it hands execution over to this startup code.  The startup script checks to make see if there&#8217;s already a zip that matches the data stuffed into the <span class="caps">MEL</span> file.  If there&#8217;s no script (or if there is a zip which is older than the <span class="caps">MEL</span> file) the startup code will extract the hidden binary data from the <span class="caps">MEL</span> and save it (currently it&#8217;s getting stashed in the Maya user directory, though it would be easy to change&nbsp;that).  </p>
<p>The <span class="caps">MEL</span> file&#8217;s startup code adds the zip to the Python path, launches Maya with the new zip as the first item on the Python path, and then executes any startup code you&#8217;ve included in the zip file &#8212; you can put any initialization you want into the zip as a  <code>__main__.py</code> and it will get fired off in the same way that an ordinary Maya session executes <code>userSetup.py</code>.  The nice thing is that the code, however complex it wants to be, is part of the overall Python codebase and not part of the small bit of startup code.  Bitter experience has taught me never to let the first bit of a startup script to be more complex than &#8220;put this stuff on the path and go&#8221; &#8212; it&#8217;s much easier to maintain and version and tweak production code than the first few lines of the bootstrapper which are always running in a very bare-bones&nbsp;context.</p>
<p>The upshot of all this is, hopefully, a complete Maya Python environment in a single file &#8212; as many modules and scripts as you need, but without the need for tools in other languages to get it plugged into a given Maya session.  It&#8217;s <span class="caps">MEL</span> and Python, so it&#8217;s cross-platform (no need to translate .<span class="caps">BATS</span> into shell scripts for <span class="caps">OSX</span> or Linux).  You can distribute this file through Perforce or a download link or simply by emailing it to one contractor; no matter how that file lands on their desk it should give them a complete environment.  If you need to give them an update you simply replace that one file and the rest follows&nbsp;naturally.</p>
<h2>Go with the&nbsp;flow</h2>
<p>I&#8217;ve been fiddling around with variation on this idea for a long time.  The primary reason I find it compelling that productions nowadays are distributed around the globe &#8212; I know, for example, that I met far less than half of the artists and animators who contributed to <strong>State of Decay 2</strong>.  A toolkit that&#8217;s easy to drop in as a single file, and which doesn&#8217;t depend on a complex web of other tools like launcher apps or perforce automation is very appealing.  It&#8217;s also nice to have a way to let outsource artists leave the party with as little friction as possible: it&#8217;s far better to simply drag one file to the trash than to remove an entire&nbsp;ecosystem.</p>
<p>Of course, all tech involves tradeoffs and I&#8217;m still trying to learn what the tradeoffs in this approach will be.  The most obvious issue is that there&#8217;s the data in the zip portion of the package ends up getting duplicated.  My work toolkit zips up about 25 mb, so the overhead is far from trememndous, but it would be nicer if there were a good way around that.  A more annoying issue is the need to extract any binary tools (such as the P4Python module) from the zip file &#8212; Python currently won&#8217;t read compiled extensions out of a zip which is irritating though easy to get around by extracting binaries to a hidden&nbsp;folder.  </p>
<p>So &#8212; I&#8217;d be curious to hear what other people think and whether this answers a need.  As always, pull requests and issue on the Github. Until then, have fun checking it out.  Help us make <span class="caps">MEL</span> great&nbsp;again!</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://theodox.github.io/tag/python.html">python</a>
      <a href="https://theodox.github.io/tag/maya.html">maya</a>
      <a href="https://theodox.github.io/tag/programming.html">programming</a>
      <a href="https://theodox.github.io/tag/distribution.html">distribution</a>
      <a href="https://theodox.github.io/tag/mel.html">MEL</a>
      <a href="https://theodox.github.io/tag/techart.html">techart</a>
    </p>
  </div>

<!--
  <div class="center social-share">
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
    <div class="addthis_inline_share_toolbox"></div>
  </div>
-->


    <div class="addthis_relatedposts_inline"></div>


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'theodoxcom';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  2018</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Chimeras & Manticores ",
  "url" : "https://theodox.github.io",
  "image": "",
  "description": ""
}
</script>


    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-575daef5596b169a"></script>

</body>
</html>