<!DOCTYPE html>
<html lang="en">
<head>
          <title>Chimeras & Manticores</title>
        <meta charset="utf-8" />
        <link href="http://theodox.com/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Chimeras & Manticores Full Atom Feed" />
        <link href="http://theodox.com/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Chimeras & Manticores Full RSS Feed" />



    <meta name="tags" content="maya" />
    <meta name="tags" content="bugs" />
    <meta name="tags" content="python" />
    <meta name="tags" content="api" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://theodox.com/">Chimeras & Manticores <strong>technical art, python, the games business, and obscurantism</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/about">About...</a></li>
            <li><a href="/pages/pub">Publications</a></li>
            <li><a href="http://astore.amazon.com/tecsurgui-20">Tech-Art Book Store</a></li>
            <li><a href="/pages/cookbook">Cookbook</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://theodox.com/2015/api_2_getpoints_bug" rel="bookmark"
         title="Permalink to Maya Bug Watch: API2 and GetPoints()">Maya Bug Watch: <span class="caps">API2</span> and&nbsp;GetPoints()</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2015-03-27T21:20:00.001000-07:00">
      Fri 27 March 2015
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>In general I’m more or less a <a href="api_2_chance.html">fan of Maya Python <span class="caps">API</span> 2.0</a>. It’s more pythonic and feels faster than the old version. However, it’s not without its quirks and I just found one that really bit me in the behind.<br />
If you want to get the vertices of an object in the api, the usual formula&nbsp;is:  </p>
<ol>
<li>Get the dagPath of the&nbsp;object</li>
<li>Make an <a href="http://help.autodesk.com/view/MAYAUL/2015/ENU/?guid=__py_ref_class_open_maya_1_1_m_fn_mesh_html">MFnMesh</a></li>
<li>Call the ‘GetPoints’ method of your&nbsp;mesh</li>
<li>Party on,&nbsp;dudes</li>
</ol>
<p>Something like this, which returns a list of <a href="http://help.autodesk.com/view/MAYAUL/2015/ENU/?guid=__py_ref_class_open_maya_1_1_m_point_html">MPoint</a> objects for the verts in the&nbsp;mesh  </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">maya.api.OpenMaya</span> <span class="kn">as</span> <span class="nn">api</span>

<span class="k">def</span> <span class="nf">get_verts</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>  
    <span class="n">mobj</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">MGlobal</span><span class="o">.</span><span class="n">getSelectionListByName</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span><span class="o">.</span><span class="n">getDagPath</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  
    <span class="c1"># that&#39;s lazy, it assumes that the first child is the mesh shape.  </span>
    <span class="c1"># in practice you need to be more careful...  </span>
    <span class="n">mfn_mesh</span> <span class="o">=</span>  <span class="n">api</span><span class="o">.</span><span class="n">MFnMesh</span><span class="p">(</span><span class="n">mobj</span><span class="p">)</span>  
    <span class="n">vert_array</span> <span class="o">=</span> <span class="n">mfn_mesh</span><span class="o">.</span><span class="n">getPoints</span><span class="p">()</span>  
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vert_array</span><span class="p">]</span>
</pre></div>


<p>This works fine and dandy…&nbsp;except:  </p>
<p><em><strong>If the mesh has 256 or more verts, the first vertex comes back as garbage</strong></em><br />
Here’s an example, using the same&nbsp;function:  </p>
<div class="highlight"><pre><span></span>mesh, _ = cmds.polyCube(sw = 1, sh= 1, sd = 1)  
print get_verts(mesh)[:4]  
#&gt; [maya.api.OpenMaya.MPoint(-0.50000000000009082, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(0.5, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.5, 0.5, 0.5, 1), maya.api.OpenMaya.MPoint(0.5, 0.5, 0.5, 1)]

# this looks good... Here&#39;s the same thing for a 226 vert cube:  
mesh, _ = cmds.polyCube(sw = 8, sh= 8, sd = 3)  
print get_verts(mesh)[:4]  
#&gt; [maya.api.OpenMaya.MPoint(-0.50000000000005185, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.375, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.25, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.125, -0.5, 0.5, 1)]

# but up the vert count to 258:  
mesh, _ = cmds.polyCube(sw = 8, sh= 8, sd = 4)  
print get_verts(mesh)[:4]  
#&gt; [maya.api.OpenMaya.MPoint(5.0277956463997711e-315, 5.0313386899592279e-315, 0.5, 1), maya.api.OpenMaya.MPoint(-0.375, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.25, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.125, -0.5, 0.5, 1)]

# that first point is gibberish: python can&#39;t go to the -315th power!
</pre></div>


<p>I’ll leave it to wiser heads to figure out <em>why</em> it works out like this. My guess is that something is borked in pointer math going on inside the wrapper around <code>MfnMesh</code>, but I don’t know. Luckily, there’s a workaround: if you create <em>new</em> MPoints out of the items coming back from the <code>GetPoints()</code> call, you get good data. I’m not sure why but this should be so but it appears to be reliable on my machine (Windows 7, 64 bit maya 2015). Here’s the&nbsp;workaround:  </p>
<div class="highlight"><pre><span></span>def safe_get_verts(mesh):  
    mobj = api.MGlobal.getSelectionListByName(mesh).getDagPath(0)  
    mfn_mesh =  api.MFnMesh(mobj)  
    vert_array = mfn_mesh.getPoints()  
    return [api.MPoint(i) for i in vert_array]  # creating new MPoints fixes the issue

mesh, _ = cmds.polyCube(sw = 10, sh= 10, sd = 10)  
print safe_get_verts(mesh)[:4]  
#&gt; [maya.api.OpenMaya.MPoint(-0.5, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.40000000596046448, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.30000001192092896, -0.5, 0.5, 1), maya.api.OpenMaya.MPoint(-0.20000001788139343, -0.5, 0.5, 1)]
</pre></div>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>