<!DOCTYPE html>
<html lang="en">
<head>
          <title>Chimeras & Manticores</title>
        <meta charset="utf-8" />
        <link href="http://theodox.com/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Chimeras & Manticores Full Atom Feed" />
        <link href="http://theodox.com/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Chimeras & Manticores Full RSS Feed" />



    <meta name="tags" content="maya" />
    <meta name="tags" content="python" />
    <meta name="tags" content="programming" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://theodox.com/">Chimeras & Manticores <strong>technical art, python, the games business, and obscurantism</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/about">About...</a></li>
            <li><a href="/pages/pub">Publications</a></li>
            <li><a href="http://astore.amazon.com/tecsurgui-20">Tech-Art Book Store</a></li>
            <li><a href="/pages/cookbook">Cookbook</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://theodox.com/2014/maya_plugin_commands" rel="bookmark"
         title="Permalink to Laziness and cleanliness and MEL, OhÂ My.">Laziness and cleanliness and <span class="caps">MEL</span>, Oh&nbsp;My.</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2014-10-26T00:18:00-07:00">
      Sun 26 October 2014
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="http://theodox.com/author/steve-theodore.html">Steve Theodore</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>The other day I was following a <a href="http://tech-artists.org/forum/showthread.php?5077-FBX-Exporting-from-Maya">thread on Tech-Artists</a> which reminded me of one of those little Maya things that doesn&#8217;t really matter, but which drives me bonkers: busted front ends for Maya&nbsp;plugins.  </p>
<p>When a developer makes a plugin for Maya, they can create new Mel commands as well as new nodes. The new commands will ultimately use the same basic strategy to parse their incoming arguments: Maya will give them an <a href="http://knowledge.autodesk.com/support/maya/learn-explore/caas/CloudHelp/cloudhelp/2015/ENU/Maya-SDK/py-ref/class-open-maya-1-1-m-arg-list-html.html">MArgList</a> object and they will have to parse out what that means. If the plugin uses an <a href="http://knowledge.autodesk.com/support/maya/getting-started/caas/CloudHelp/cloudhelp/2015/ENU/Maya-SDK/py-ref/class-open-maya-1-1-m-syntax-html.html">MSyntax</a> and an <a href="http://knowledge.autodesk.com/support/maya/getting-started/caas/CloudHelp/cloudhelp/2015/ENU/Maya-SDK/py-ref/class-open-maya-1-1-m-arg-parser-html.html">MArgParser</a> to pull the values out then the plugin will behave just like the functions in maya.cmds.  Flags and arguments will be checked the same way that we&#8217;re used to in the rest of Maya&nbsp;Python.  </p>
<p>Unfortunately, there&#8217;s no law that says the plugin has to do it &#8216;correctly&#8217;.  There are more than a few plugins that don&#8217;t use the standard MSyntax/MArgParser combo and just pull values out of the argument list directly.  The most notorious offender is the <span class="caps">FBX</span> Plugin, which generates a ton of commands which all fail to use the standard parsing mechanism.  And, of course, there are also bits of <span class="caps">MEL</span> lying around from other sources as well that are a bit painful to call from Python, That&#8217;s why you see tons of hairy beasts like&nbsp;this:      </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">maya.mel</span> <span class="kn">as</span> <span class="nn">mel</span>  
<span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexStart -v &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_frames</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>  
<span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexEnd -v &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">end_frames</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>  
<span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;FBXExport -f </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">get_export_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fbx</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>


<p>While this is workable, it&#8217;s fragile: composing strings inline inside a function call is an invitation to bugs like forgetting an escaped quote (tell me you&#8217;d notice that last escape in the final line if it was borked!) or a bit of significant whitespace. It&#8217;s also harder to meta-program anything that&#8217;s written like this - you can&#8217;t create a dictionary of options or a variable length list of arguments when you call the function. Last - but not least, at least not for lousy typists like myself - you can&#8217;t rely on autocompletion in your <span class="caps">IDE</span> to make things quicker and less error&nbsp;prone.  </p>
<p>In cases like this it&#8217;s handy to be able to fall back on a wrapper that will feed the plugin a correctly formatted <span class="caps">MEL</span>-style argument but which looks and codes like regular Maya Python. Luckily, you can usually rely on the <span class="caps">MEL</span> syntax, even when the plugin&#8217;s argument parsing is as Python-unfriendly as the <span class="caps">FBX</span> plugins: If the <span class="caps">MEL</span> version doesn&#8217;t work either, the whole thing isn&#8217;t worth rescuing ! &#8212; but if it does then you can Python-ify the front end with a little bit of Python magic to make sure the arguments are passed&nbsp;correctly.  </p>
<p>One thing we can do to make this a simple job is to use what&#8217;s known as <em><span class="caps">MEL</span> function syntax</em>.  This is a little-used <span class="caps">MEL</span> behavior that lets you call <span class="caps">MEL</span> more or less like a traditional computer function, rather than the shell-style script format you usually see. Function syntax uses parentheses and a comma-delimited list of arguments rather than white space. It means that these two calls are&nbsp;identical:  </p>
<div class="highlight"><pre><span></span>spaceLocator -p 1 2 3 -n &quot;fred&quot;;  
spaceLocator(&quot;-p&quot;, &quot;1&quot;, &quot;2&quot;,  &quot;3&quot;,  &quot;-n&quot;,  &quot;fred&quot;);
</pre></div>


<p>While you probably don&#8217;t want to type that second one, it&#8217;s a lot easier to manage if you&#8217;re trying to turn a bunch of flags and arguments into a <span class="caps">MEL</span> command string.  What we&#8217;ll be doing is creating a function that generates argument strings in the function syntax style and then passes them to <span class="caps">MEL</span> for you, allowing you to use the familiar cmds-style arguments and keywords instead of doing all the string assembly in-line with your other&nbsp;code.  </p>
<p>The rest of the relevant <span class="caps">MEL</span> syntax rules are pretty simple, with one exception we&#8217;ll touch on&nbsp;later:  </p>
<ul>
<li><em>Everything</em> is a&nbsp;string!</li>
<li>Flags are preceded by a&nbsp;dash</li>
<li>Flags come&nbsp;first</li>
<li>Non-flag arguments follow&nbsp;flags</li>
<li>Multipart values are just a series of single&nbsp;values</li>
</ul>
<p>That first one may suprise you but it&#8217;s true - and in our case it&#8217;s extremely useful. If you&#8217;re dubious, though, try this in your <span class="caps">MEL</span>&nbsp;listener:  </p>
<div class="highlight"><pre><span></span>polyCube (&quot;-name&quot;, &quot;hello&quot;, &quot;-width&quot;, &quot;999&quot;);
</pre></div>


<p>Implementing these rules in a function turns out to be pretty&nbsp;simple.   </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">maya.mel</span>  
<span class="k">def</span> <span class="nf">run_mel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  
    <span class="c1"># makes every value into a tuple or list so we can string them together easily  </span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">v</span><span class="p">,)</span>  
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>  
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>   
        <span class="n">output</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="s2">&quot;-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>  
        <span class="c1"># if the flag value is True of False, skip it   </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">**</span><span class="ow">in</span> <span class="p">(</span><span class="o">**</span><span class="bp">True</span><span class="o">**</span><span class="p">,</span> <span class="o">**</span><span class="bp">False</span><span class="o">**</span><span class="p">)</span><span class="o">**</span><span class="p">:</span>  
            <span class="n">output</span><span class="o">.</span><span class="n">extend</span> <span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>  
        <span class="n">output</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="n">quoted</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">maya</span><span class="o">.</span><span class="n">mel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">quoted</span><span class="p">,</span> <span class="n">output</span><span class="p">))))</span>
</pre></div>


<p>This function will correctly format a <span class="caps">MEL</span> call for almost all circumstances (see the note below for the exception).  For example the irritating <span class="caps">FBX</span> commands above&nbsp;become  </p>
<div class="highlight"><pre><span></span><span class="n">run_mel</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexStart&quot;</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">start_frames</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>  
<span class="n">run_mel</span><span class="p">(</span><span class="s2">&quot;FBXExportBakeComplexEnd&quot;</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">end_frames</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>  
<span class="n">run_mel</span><span class="p">(</span><span class="s2">&quot;FBXExport&quot;</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">get_export_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fbx&quot;</span><span class="p">)</span>
</pre></div>


<p>That&#8217;s a big improvement over all that string assembly (not leastaways because it pushes all the string nonsense into one place where it&#8217;s easy to find and fix bugs!)   However it&#8217;s still a bit ugly. Wouldn&#8217;t it be cleaner and more readable to nudge these guys another step towards looking like real&nbsp;Python?  </p>
<p>Luckily that&#8217;s quite easy to do. After all, the run_mel(&#8220;command&#8221;) part of this is the same except for the command names. So why not make a second function that makes functions with the right command names?  This is basically just a tweak on the way decorators work. For&nbsp;example:  </p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mel_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">wrap</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  
        <span class="k">return</span> <span class="n">run_mel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">wrap</span>
</pre></div>


<p>This takes a <span class="caps">MEL</span> command name (&#8220;cmd&#8221;) and makes a new function which calls run_mel using that command. So you can create objects which look and work like Python commands but do all the nasty mel stuff under the hood like&nbsp;this:  </p>
<div class="highlight"><pre><span></span>FBXExport = mel_cmd(&quot;FBXExport&quot;)      
FBXExportBakeComplexStart = mel_cmd(&quot;FBXExportBakeComplexStart&quot;)  
FBXExportBakeComplexEnd = mel_cmd(&quot;FBXExportBakeComplexEnd&quot;)
</pre></div>


<p>And call them just like real&nbsp;Python:    </p>
<div class="highlight"><pre><span></span><span class="n">FBXExport</span><span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="s2">&quot;this_is_a_lot_nicer.fbx&quot;</span><span class="p">)</span>
</pre></div>


<p>All this might seem like a bit of extra work &#8212; and it is, though its not much more work than all those laboriously hand-stitched string concatenations you&#8217;d have to do&nbsp;otherwise.</p>
<p>More importantly, this actually is a case where code cleanliness is next to Godliness: keeping rogue <span class="caps">MEL</span> from invading your python code is a big boon to long term maintenance.  String assembly is notoriously bug prone: it&#8217;s way too easy to miss a closing quote, or to append something that&#8217;s not a string and bring the whole rickety edifice crashing down.  Moreover, exposing all of that stringy stuff to other code makes it impossible to do clever python tricks like passing keyword arguments as dictionaries.  So in this case, a little upfront work is definitely worth&nbsp;it.  </p>
<p>Plus, if you&#8217;re lazy like me you can import these functions in a module and they&#8217;ll autocomplete. Fat Fingers <span class="caps">FTW</span>!   </p>
<p>So, if you find this useful, the complete code is <a href="https://gist.github.com/theodox/9a2e2b92867fa82ea328">up on&nbsp;Github.</a>  </p>
<h3>Note</h3>
<p>If you&#8217;re a real mel-head you may have noticed one limitation in the <code>run_mel()</code>implementation above.  <span class="caps">MEL</span> allows multi-use flags, for commands&nbsp;like  </p>
<div class="highlight"><pre><span></span>ls -type transform -type camera
</pre></div>


<p>However the function here doesn&#8217;t try to figure format arguments that way. In part because it&#8217;s a relatively rare feature in <span class="caps">MEL</span>, but mostly because it doesn&#8217;t occur in the places I&#8217;ve needed to wrap <span class="caps">MEL</span> commands.  It would not be hard to extend the function so you could annotate some flags as being multi-use - if you give it a whirl let me know and I&#8217;ll post it for others to&nbsp;see.  </p>
<h3>Bonus&nbsp;Round</h3>
<p>The <a href="https://gist.github.com/theodox/2b83b1c47a18448d3cbf">Github also has another module</a> which uses the same basic idea (but a slightly different code structure) to wrap that stupid <span class="caps">FBX</span>&nbsp;plugin.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>